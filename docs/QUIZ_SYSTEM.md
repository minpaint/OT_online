# Система тестирования по охране труда (Quiz System)

## Обзор

Система тестирования предназначена для проверки знаний сотрудников по вопросам охраны труда. Реализована полностью с нуля с использованием Django и интегрирована в существующий проект OT_online.

## Основные возможности

### 1. Два режима тестирования

#### Режим "Обучение по теме"
- Прохождение всех вопросов из выбранной категории
- Последовательное изучение материала по конкретной теме
- Показ правильного ответа сразу после выбора (опционально)
- Возможность пропускать вопросы

#### Режим "Экзамен"
- Случайная выборка вопросов из всех активных категорий
- Настраивается общее количество вопросов (по одному из раздела в пределах лимита)
- Конфигурируются лимит времени и количество допустимых ошибок
- Случайный порядок вопросов

### 2. Функциональность для пользователей

- Просмотр доступных квизов и категорий
- Прохождение тестов с подсчетом результатов
- История всех попыток прохождения
- Детальный просмотр результатов с правильными/неправильными ответами
- Статистика: правильные ответы, пропущенные вопросы, процент прохождения

### 3. Функциональность для администраторов

- Создание и управление категориями квизов
- Создание квизов с гибкими настройками
- Добавление вопросов с изображениями
- Inline-редактирование вариантов ответов через nested_admin
- Просмотр статистики прохождения всех пользователей
- Экспорт/импорт вопросов (планируется)

## Архитектура

### Модели данных

#### QuizCategory
Категория/тема квиза (например, "Общие вопросы по охране труда")

**Поля:**
- `name` - название категории
- `description` - описание
- `order` - порядок сортировки
- `is_active` - активность категории

**Методы:**
- `get_questions_count()` - количество активных вопросов в категории

#### Quiz
Квиз/тест

**Поля:**
- `title` - название
- `description` - описание
- `quiz_type` - тип квиза (training/exam)
- `category` - категория (для режима обучения)
- `questions_per_category` - количество вопросов из каждой категории (общая настройка)
- `exam_total_questions` - максимум вопросов в экзаменационной попытке
- `exam_time_limit` - лимит времени в минутах
- `exam_allowed_incorrect` - допустимое число неправильных ответов
- `random_order` - случайный порядок вопросов
- `show_correct_answer` - показывать правильный ответ сразу
- `allow_skip` - разрешить пропускать вопросы
- `attempts_count` - счетчик попыток
- `is_active` - активность

**Методы:**
- `get_questions()` - получить список вопросов для квиза
- `get_total_questions()` - общее количество вопросов

#### Question
Вопрос квиза

**Поля:**
- `category` - категория вопроса
- `question_text` - текст вопроса
- `image` - изображение (опционально)
- `explanation` - пояснение к правильному ответу
- `order` - порядок сортировки
- `is_active` - активность

**Методы:**
- `get_answers()` - получить все варианты ответов
- `get_correct_answer()` - получить правильный ответ

#### Answer
Вариант ответа

**Поля:**
- `question` - вопрос
- `answer_text` - текст ответа
- `is_correct` - правильный ли ответ
- `order` - порядок отображения

#### QuizAttempt
Попытка прохождения квиза

**Поля:**
- `quiz` - квиз
- `user` - пользователь
- `status` - статус (in_progress/completed/abandoned)
- `total_questions` - всего вопросов
- `correct_answers` - правильных ответов
- `skipped_questions` - пропущено вопросов
- `incorrect_answers` - неправильных ответов
- `score_percentage` - результат в процентах
- `passed` - тест пройден
- `time_limit_seconds` - лимит времени (сек) на момент начала попытки
- `allowed_incorrect_answers` - допустимый лимит ошибок
- `max_questions` - ограничение по количеству вопросов
- `failure_reason` - причина завершения (успешно, время вышло, лимит ошибок)
- `started_at` - время начала
- `completed_at` - время завершения

**Методы:**
- `calculate_score()` - рассчитать результат

#### UserAnswer
Ответ пользователя на вопрос

**Поля:**
- `attempt` - попытка
- `question` - вопрос
- `selected_answer` - выбранный ответ (NULL если пропущен)
- `is_correct` - правильно ли ответил
- `is_skipped` - был ли вопрос пропущен
- `answered_at` - время ответа

## URL-маршруты

```python
# Список квизов
/quiz/

# Начало прохождения квиза
/quiz/<quiz_id>/start/

# Отображение вопроса
/quiz/<attempt_id>/question/<question_number>/

# Обработка ответа (AJAX)
/quiz/<attempt_id>/answer/<question_id>/

# Результаты прохождения
/quiz/<attempt_id>/result/

# История прохождений пользователя
/quiz/history/

# Детали категории
/quiz/category/<category_id>/
```

## Views (представления)

### quiz_list
Список доступных квизов с разделением на обучающие и экзамены. Показывает статистику пользователя.

### quiz_start
Создание новой попытки прохождения или продолжение незавершенной. Генерирует случайный порядок вопросов и сохраняет в сессии.

### quiz_question
Отображение вопроса с вариантами ответов. Показывает прогресс прохождения и статистику.

### quiz_answer (AJAX)
Обработка ответа пользователя. Возвращает JSON с информацией о правильности ответа.

### quiz_result
Итоговые результаты прохождения с детализацией по вопросам.

### quiz_history
История всех попыток прохождения квизов пользователя.

### category_detail
Детальная информация о категории с списком вопросов.

## Админ-панель

### QuizCategoryAdmin
- Список категорий с количеством вопросов
- Inline-редактирование порядка и активности
- Фильтры по активности и дате создания

### QuizAdmin
- Управление квизами
- Настройка параметров прохождения
- Fieldsets с логической группировкой полей
- Валидация связи категории для обучающих квизов

### QuestionAdmin (NestedModelAdmin)
- Создание вопросов с inline-добавлением ответов
- Превью изображений в списке
- Nested inline для удобного редактирования ответов
- Фильтры по категориям

### AnswerAdmin
- Отдельное управление ответами (если нужно)
- Ссылки на родительские вопросы

### QuizAttemptAdmin
- Просмотр всех попыток прохождения
- Цветовая индикация результатов
- Inline-просмотр ответов пользователя
- Фильтры по статусу, дате, квизу
- Запрет создания через админку

### UserAnswerAdmin
- Детальный просмотр ответов пользователей
- Ссылки на попытки и вопросы
- Только для чтения

## Дизайн

Дизайн разработан на основе предоставленных изображений:

### Цветовая схема
- Основной фон: Бирюзовый (#17a2b8)
- Блоки вопросов: Белый с рамкой
- Варианты ответов: Светло-серый
- Правильный ответ: Зеленая подсветка
- Неправильный ответ: Красная подсветка

### Элементы интерфейса
- Заголовок с прогрессом: "Вопрос № X из Y (пропущено: Z)"
- Текст вопроса в рамке
- Изображение справа от вопроса
- 4 пронумерованных варианта ответа
- Кнопка "Пропустить" внизу справа
- Прогресс-бар прохождения

## Технические детали

### Зависимости
- `django-model-utils` - для TimeStampedModel (created, modified)
- `Pillow` - для работы с изображениями
- `nested-admin` - для вложенных форм в админке
- `pymorphy3` - для склонения (уже используется в проекте)

### Сессии
Порядок вопросов хранится в сессии Django:
```python
request.session[f'quiz_questions_{attempt.id}'] = [question_ids]
```

### AJAX-запросы
Ответы на вопросы обрабатываются через AJAX для динамичного интерфейса:
```javascript
fetch(`/quiz/${attemptId}/answer/${questionId}/`, {
    method: 'POST',
    body: formData
})
```

## Будущие улучшения

### Планируется реализовать:

1. **Management command для парсинга изображений**
   - Автоматическое распознавание текста вопросов (OCR)
   - Извлечение вариантов ответов
   - Импорт в базу данных

2. **Шаблоны с полным дизайном**
   - HTML/CSS на основе предоставленных изображений
   - Адаптивная верстка
   - JavaScript для интерактивности

3. **Расширенная статистика**
   - Графики прохождения
   - Сравнение с другими пользователями
   - Рекомендации по слабым темам

4. **Экспорт/импорт вопросов**
   - CSV/Excel формат
   - Массовый импорт через админку
   - Шаблоны для заполнения

5. **Ограничение по времени**
   - Таймер для экзаменов
   - Автоматическое завершение по истечении времени

6. **Сертификаты**
   - Генерация PDF-сертификатов при прохождении
   - Шаблоны сертификатов

7. **Уведомления**
   - Email при назначении квиза
   - Напоминания о прохождении
   - Уведомления о результатах

## Использование

### Для администраторов

1. Зайти в админ-панель Django
2. Создать категории квизов (QuizCategory)
3. Создать вопросы с ответами (Question -> Answer через inline)
4. Создать квизы с настройками (Quiz)
5. Активировать квизы для пользователей

### Для пользователей

1. Перейти на `/quiz/`
2. Выбрать квиз из списка
3. Нажать "Начать"
4. Отвечать на вопросы
5. Просмотреть результаты

### Для разработчиков

#### Создание новой категории программно:
```python
from directory.models import QuizCategory

category = QuizCategory.objects.create(
    name="Общие вопросы по охране труда",
    description="Базовые знания по охране труда",
    order=1,
    is_active=True
)
```

#### Создание вопроса с ответами:
```python
from directory.models import Question, Answer

question = Question.objects.create(
    category=category,
    question_text="Что обязан предпринять работодатель...",
    is_active=True
)

# Правильный ответ
Answer.objects.create(
    question=question,
    answer_text="Назначить лиц, ответственных...",
    is_correct=True,
    order=1
)

# Неправильные ответы
Answer.objects.create(
    question=question,
    answer_text="Организовать систематическое...",
    is_correct=False,
    order=2
)
```

#### Создание квиза:
```python
from directory.models import Quiz

# Обучающий квиз
training_quiz = Quiz.objects.create(
    title="Общие вопросы ОТ - Обучение",
    quiz_type=Quiz.QUIZ_TYPE_TRAINING,
    category=category,
    random_order=True,
    show_correct_answer=True,
    allow_skip=True,
    is_active=True
)

# Экзамен
exam_quiz = Quiz.objects.create(
    title="Экзамен по охране труда",
    quiz_type=Quiz.QUIZ_TYPE_EXAM,
    questions_per_category=5,
    exam_total_questions=10,
    exam_time_limit=30,
    exam_allowed_incorrect=3,
    random_order=True,
    show_correct_answer=False,
    allow_skip=False,
    is_active=True
)
```

## Файловая структура

```
directory/
├── models/
│   └── quiz.py                    # Модели квизов
├── admin/
│   └── quiz_admin.py              # Админ-панель
├── views/
│   └── quiz_views.py              # Представления
├── templates/
│   └── directory/
│       └── quiz/
│           ├── quiz_list.html     # Список квизов
│           ├── quiz_question.html # Отображение вопроса
│           ├── quiz_result.html   # Результаты
│           ├── quiz_history.html  # История
│           └── category_detail.html
├── static/
│   └── directory/
│       ├── css/
│       │   └── quiz.css          # Стили квизов
│       └── js/
│           └── quiz.js           # JavaScript для AJAX
└── management/
    └── commands/
        └── parse_quiz_images.py  # Парсинг изображений

media/
└── quiz/
    └── questions/                # Загруженные изображения
```

## Миграции

Все модели добавлены в миграцию `0025_add_quiz_models.py`:
- Создание таблиц для всех моделей
- Связи между моделями
- Индексы для оптимизации запросов

## Безопасность

- Все views защищены декоратором `@login_required`
- Пользователи могут видеть только свои попытки
- AJAX-запросы проверяют права доступа
- CSRF-защита для всех POST-запросов
- Валидация данных на уровне моделей

## Производительность

- `select_related()` для оптимизации запросов
- Кэширование порядка вопросов в сессии
- Индексы на часто используемых полях
- Lazy loading для изображений

## Тестирование

Рекомендуется создать тесты для:
- Создания квизов и вопросов
- Прохождения квизов
- Подсчета результатов
- Случайной выборки для экзаменов
- API-endpoints

## Поддержка

При возникновении вопросов или проблем:
1. Проверьте логи Django
2. Убедитесь, что все миграции применены
3. Проверьте настройки MEDIA_URL и MEDIA_ROOT
4. Проверьте права доступа к директории media/quiz/

## История изменений

### v1.0.0 (27.10.2025)
- Первая версия системы тестирования
- Модели данных
- Админ-панель с nested_admin
- Views и URL-маршруты
- Документация

## Лицензия

Часть проекта OT_online - система управления охраной труда.
