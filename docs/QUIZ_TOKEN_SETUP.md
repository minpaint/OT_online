# Настройка системы квизов с токенами на поддомене

## Описание системы

Система позволяет создавать безопасные токены доступа к экзаменам на изолированном поддомене `exam.localhost:8001`. Это обеспечивает:
- Ограниченный доступ только к экзамену
- Блокировку индексации поисковыми системами
- Невозможность навигации по другим разделам сайта
- Временные ограничения доступа
- Возможность возобновления экзамена

## Шаг 1: Настройка hosts файла

Откройте файл hosts с правами администратора:
- Windows: `C:\Windows\System32\drivers\etc\hosts`
- Linux/Mac: `/etc/hosts`

Добавьте строку:
```
127.0.0.1    exam.localhost
```

Сохраните файл.

## Шаг 2: Запуск сервера

Запустите Django сервер на порту 8001:

```bash
python manage.py runserver 0.0.0.0:8001
```

## Шаг 3: Создание токена доступа

1. Зайдите в админку: http://localhost:8001/admin/
2. Перейдите в раздел "Токены доступа к экзаменам"
3. Нажмите "Добавить токен доступа к экзамену"
4. Заполните поля:
   - **Экзамен**: выберите экзамен
   - **Пользователь**: выберите пользователя
   - **Действителен с**: дата/время начала доступа
   - **Действителен до**: дата/время окончания доступа
   - **Описание**: например, "Экзамен для Иванова И.И."
5. Сохраните токен
6. Скопируйте ссылку из поля "Ссылка доступа"

## Шаг 4: Тестирование

### Вариант A: Тестирование как администратор

1. Авторизуйтесь как суперпользователь
2. Откройте ссылку токена (например: `http://exam.localhost:8001/directory/quiz/access/123e4567-e89b-12d3-a456-426614174000/`)
3. Вас перенаправит на **главную страницу exam поддомена**
4. На главной странице вы увидите:
   - Информацию об экзамене (время, количество вопросов)
   - Блок "Подготовка: тренировки по разделам" с карточками разделов
   - Блок "Экзамен" с кнопкой начала/продолжения
5. Попробуйте открыть другие URL (не quiz) - должна быть блокировка 403

### Вариант B: Тестирование как обычный пользователь

1. Авторизуйтесь как пользователь, указанный в токене
2. Откройте ссылку токена
3. Вас перенаправит на экзамен
4. Пройдите экзамен или закройте браузер
5. Откройте ссылку снова - экзамен продолжится с того же места (если allow_resume=True)

### Что должно работать:

✅ Доступ по токену перенаправляет на главную страницу exam поддомена
✅ Главная страница показывает:
  - Информацию об экзамене (заголовок, описание, параметры)
  - Карточки разделов для тренировки
  - Блок экзамена с кнопкой "Начать экзамен" / "Продолжить экзамен" / "Пройти снова"
  - Статистику последней попытки (если есть)
✅ В токен-режиме доступны только URL вида `/directory/quiz/*`
✅ Попытки открыть другие URL возвращают 403 Forbidden
✅ После завершения экзамена пользователь может вернуться на главную страницу для повторной попытки
✅ Администраторы могут тестировать любые токены
✅ Шаблоны используют минималистичный base_token_mode.html
✅ Тренировки открываются в том же токен-режиме
✅ Возобновление незавершённого экзамена работает

### Что должно блокироваться:

❌ Доступ к /directory/employees/
❌ Доступ к /directory/equipment/
❌ Доступ к любым другим разделам кроме quiz
❌ Навигационное меню не отображается (используется base_token_mode.html)

## Шаг 5: Проверка логов

Все попытки несанкционированного доступа логируются в файл `django.log`:

```bash
tail -f django.log | grep "exam_security"
```

Пример лога:
```
[WARNING] 2025-10-30 17:00:00 exam_subdomain: Exam subdomain access blocked: IP=127.0.0.1, Path=/directory/employees/, Method=GET, User=testuser, Reason=Blocked: not quiz URL in token mode
```

## Настройки в settings.py

```python
# Домен для экзаменационного поддомена
EXAM_SUBDOMAIN = os.getenv('EXAM_SUBDOMAIN', 'exam.localhost:8001')
EXAM_PROTOCOL = os.getenv('EXAM_PROTOCOL', 'http')

# В продакшене используйте:
# EXAM_SUBDOMAIN = 'exam.yourdomain.com'
# EXAM_PROTOCOL = 'https'
```

## Переменные окружения (.env)

```env
EXAM_SUBDOMAIN=exam.localhost:8001
EXAM_PROTOCOL=http
```

## Возможные проблемы и решения

### Проблема: "Access Denied" при открытии токена

**Решение:**
1. Проверьте, что пользователь авторизован
2. Проверьте, что токен не истек (valid_from <= now <= valid_until)
3. Проверьте, что токен активен (is_active=True)
4. Проверьте, что токен не использован (или allow_resume=True)

### Проблема: Не работает exam.localhost

**Решение:**
1. Проверьте hosts файл
2. Очистите кеш DNS: `ipconfig /flushdns` (Windows) или `sudo dscacheutil -flushcache` (Mac)
3. Перезагрузите браузер
4. Попробуйте использовать 127.0.0.1:8001 вместо exam.localhost:8001

### Проблема: Middleware не работает

**Решение:**
1. Проверьте, что middleware добавлен в settings.py:
   ```python
   MIDDLEWARE = [
       ...
       'directory.middleware.ExamSubdomainMiddleware',
   ]
   ```
2. Перезапустите сервер

## Архитектура системы

```
┌─────────────────────────────────────────┐
│  exam.localhost:8001                    │
│  (изолированный поддомен)               │
└─────────────────┬───────────────────────┘
                  │
                  ▼
    ┌─────────────────────────────┐
    │  ExamSubdomainMiddleware    │
    │  - Проверка домена          │
    │  - Проверка токен-режима    │
    │  - Блокировка неразрешённых │
    │    URL                      │
    └─────────────┬───────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
        ▼                   ▼
  ┌──────────┐      ┌──────────────┐
  │ Разрешён │      │ Заблокирован │
  │ (quiz)   │      │ (403)        │
  └──────────┘      └──────────────┘
```

## Следующие шаги

1. Для продакшена настройте nginx/Apache для маршрутизации exam.* на Django
2. Настройте HTTPS для безопасности
3. Добавьте мониторинг логов безопасности
4. Настройте уведомления о подозрительной активности
