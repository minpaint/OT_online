/**
 * üå≥ –Ø–¥—Ä–æ –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ—Ä–µ–≤–æ–º –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—ã–º–∏ –º–æ–¥—É–ª—è–º–∏ (—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ, —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ, —á–µ–∫–±–æ–∫—Å—ã)
 */
class TreeCore {
    constructor() {
        // üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        this.tree = document.getElementById('result_list') || document.getElementById('employeeTree');
        this.expandAllBtn = document.querySelector('.expand-all');
        this.collapseAllBtn = document.querySelector('.collapse-all');
        this.searchInput = document.querySelector('.tree-search') || document.getElementById('localSearchInput');
        this.selectAllCheckbox = document.getElementById('select-all'); // –ì–ª–∞–≤–Ω—ã–π —á–µ–∫–±–æ–∫—Å "–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ"

        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏
        this.actionsDropdown = document.getElementById('actionsDropdown');
        this.selectedCounter = document.getElementById('selectedCounter');
        this.counterValue = document.getElementById('counterValue');

        this.selectedEmployees = []; // –ú–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (–∞–¥–º–∏–Ω–∫–∞ –∏–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥)
        this.isAdminMode = this.tree && this.tree.id === 'result_list';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        this.init();
    }

    init() {
        if (!this.tree) return;
        this._bindEvents();
        this._restoreState();
        this._initCheckboxes();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏–π —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        this._initEmployeeActions();
    }

    _bindEvents() {
        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
        this.tree.addEventListener('click', (e) => {
            if (e.target.classList.contains('toggle-btn') || e.target.classList.contains('tree-toggle')) {
                this._handleToggleClick(e);
            }
        });

        if (this.expandAllBtn) {
            this.expandAllBtn.addEventListener('click', () => this.expandAll());
        }
        if (this.collapseAllBtn) {
            this.collapseAllBtn.addEventListener('click', () => this.collapseAll());
        }
    }

    _handleToggleClick(event) {
        const button = event.target.closest('.toggle-btn, .tree-toggle');
        if (!button) return;

        let row, nodeId;

        if (button.classList.contains('toggle-btn')) {
            row = button.closest('tr');
            nodeId = row.dataset.nodeId;
            const isExpanded = button.getAttribute('data-state') === 'expanded';
            this.toggleNode(nodeId, !isExpanded);
        } else if (button.classList.contains('tree-toggle')) {
            nodeId = button.dataset.node;
            const isExpanded = button.textContent === '-';
            this.toggleNodeByToggleIcon(nodeId, !isExpanded);
        }
    }

    toggleNode(nodeId, expand = true) {
        const row = this.tree.querySelector(`tr[data-node-id="${nodeId}"]`);
        if (!row) return;

        const button = row.querySelector('.toggle-btn');
        if (!button) return;

        button.setAttribute('data-state', expand ? 'expanded' : 'collapsed');
        button.textContent = expand ? '[-]' : '[+]';

        // –î–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        const childRows = this.tree.querySelectorAll(`tr[data-parent-id="${nodeId}"]`);
        childRows.forEach(childRow => {
            childRow.classList.toggle('tree-row-hidden', !expand);
            if (!expand) {
                // –ï—Å–ª–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—è, —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∏ –¥–æ—á–µ—Ä–Ω–∏–µ
                const childBtn = childRow.querySelector('.toggle-btn');
                if (childBtn) {
                    const cId = childRow.dataset.nodeId;
                    if (cId) {
                        this.toggleNode(cId, false);
                    }
                }
            }
        });

        this._saveState();
    }

    toggleNodeByToggleIcon(nodeId, expand = true) {
        const toggleElement = this.tree.querySelector(`.tree-toggle[data-node="${nodeId}"]`);
        if (!toggleElement) return;

        toggleElement.textContent = expand ? '-' : '+';

        const children = this.tree.querySelectorAll(`tr[data-parent="${nodeId}"]`);
        children.forEach(child => {
            if (expand) {
                child.classList.remove('tree-hidden');
            } else {
                child.classList.add('tree-hidden');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —Ä–µ–±–µ–Ω–∫–∞ —Å–≤–æ–∏ –¥–µ—Ç–∏
                const childNodeId = child.dataset.nodeId;
                if (childNodeId) {
                    this.toggleNodeByToggleIcon(childNodeId, false);
                }
            }
        });
    }

    expandAll() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø toggle-—ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const hasToggleBtn = this.tree.querySelector('.toggle-btn');
        const hasTreeToggle = this.tree.querySelector('.tree-toggle');

        if (hasToggleBtn) {
            const buttons = this.tree.querySelectorAll('.toggle-btn[data-state="collapsed"]');
            buttons.forEach(btn => {
                const row = btn.closest('tr');
                const nodeId = row.dataset.nodeId;
                if (nodeId) {
                    this.toggleNode(nodeId, true);
                }
            });
        } else if (hasTreeToggle) {
            const toggles = this.tree.querySelectorAll('.tree-toggle');
            toggles.forEach(toggle => {
                const nodeId = toggle.dataset.node;
                if (nodeId) {
                    this.toggleNodeByToggleIcon(nodeId, true);
                }
            });
        }
    }

    collapseAll() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø toggle-—ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const hasToggleBtn = this.tree.querySelector('.toggle-btn');
        const hasTreeToggle = this.tree.querySelector('.tree-toggle');

        if (hasToggleBtn) {
            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ—Ä–Ω–µ–≤—ã–µ, –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∞–≤—Ç–æ–º–∞—Ç–æ–º —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è
            const rootRows = this.tree.querySelectorAll('tr[data-level="0"]');
            rootRows.forEach(row => {
                const nodeId = row.dataset.nodeId;
                if (nodeId) {
                    this.toggleNode(nodeId, false);
                }
            });
        } else if (hasTreeToggle) {
            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ—Ä–Ω–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏)
            const orgNodes = this.tree.querySelectorAll('.tree-toggle[data-node^="org-"]');
            orgNodes.forEach(node => {
                const nodeId = node.dataset.node;
                this.toggleNodeByToggleIcon(nodeId, false);
            });
        }
    }

    _saveState() {
        const state = {};
        this.tree.querySelectorAll('.toggle-btn').forEach(btn => {
            const row = btn.closest('tr');
            const nodeId = row.dataset.nodeId;
            if (nodeId) {
                state[nodeId] = btn.getAttribute('data-state');
            }
        });
        localStorage.setItem('treeViewState', JSON.stringify(state));
    }

    _restoreState() {
        try {
            const state = JSON.parse(localStorage.getItem('treeViewState'));
            if (state) {
                Object.entries(state).forEach(([nodeId, st]) => {
                    this.toggleNode(nodeId, st === 'expanded');
                });
            }
        } catch (err) {
            console.error('Error restoring tree state:', err);
        }
    }

    _initCheckboxes() {
        if (!this.selectAllCheckbox) return;

        this.selectAllCheckbox.addEventListener('change', () => {
            const checkboxes = this.tree.querySelectorAll('input[name="_selected_action"], .employee-checkbox');
            checkboxes.forEach(ch => {
                ch.checked = this.selectAllCheckbox.checked;

                // –ï—Å–ª–∏ —ç—Ç–æ —á–µ–∫–±–æ–∫—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
                if (ch.classList.contains('employee-checkbox')) {
                    const employeeId = ch.dataset.id;
                    const index = this.selectedEmployees.indexOf(employeeId);

                    if (this.selectAllCheckbox.checked && index === -1) {
                        this.selectedEmployees.push(employeeId);
                    } else if (!this.selectAllCheckbox.checked && index !== -1) {
                        this.selectedEmployees.splice(index, 1);
                    }
                }
            });

            this._updateSelectedCounter();
        });

        this.tree.addEventListener('change', (e) => {
            const checkbox = e.target;
            if (!checkbox.matches('input[type="checkbox"]')) return;

            if (checkbox.classList.contains('employee-checkbox')) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                const employeeId = checkbox.dataset.id;
                const index = this.selectedEmployees.indexOf(employeeId);

                if (checkbox.checked && index === -1) {
                    this.selectedEmployees.push(employeeId);
                } else if (!checkbox.checked && index !== -1) {
                    this.selectedEmployees.splice(index, 1);
                }

                this._updateSelectedCounter();
            } else if (checkbox.classList.contains('org-checkbox') ||
                      checkbox.classList.contains('sub-checkbox') ||
                      checkbox.classList.contains('dept-checkbox')) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ/–æ—Ç–¥–µ–ª)
                const nodeId = checkbox.dataset.id;
                const children = this.tree.querySelectorAll(`tr[data-parent="${nodeId}"] input[type="checkbox"]`);

                children.forEach(childCheckbox => {
                    childCheckbox.checked = checkbox.checked;

                    // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                    if (childCheckbox.classList.contains('employee-checkbox')) {
                        const empId = childCheckbox.dataset.id;
                        const index = this.selectedEmployees.indexOf(empId);

                        if (checkbox.checked && index === -1) {
                            this.selectedEmployees.push(empId);
                        } else if (!checkbox.checked && index !== -1) {
                            this.selectedEmployees.splice(index, 1);
                        }
                    }
                });

                this._updateSelectedCounter();
            } else if (checkbox.classList.contains('action-select')) {
                this._updateSelectAllState();
            }
        });
    }

    _updateSelectAllState() {
        if (!this.selectAllCheckbox) return;
        const checkboxes = this.tree.querySelectorAll('input[name="_selected_action"], .employee-checkbox');
        const checked = this.tree.querySelectorAll('input[name="_selected_action"]:checked, .employee-checkbox:checked');

        this.selectAllCheckbox.checked = (checkboxes.length === checked.length);
        this.selectAllCheckbox.indeterminate = (checked.length > 0 && checked.length < checkboxes.length);

        this._updateSelectedCounter();
    }

    _updateSelectedCounter() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const count = this.selectedEmployees.length;

        if (this.counterValue) {
            this.counterValue.textContent = count;
        }

        if (this.selectedCounter) {
            if (count > 0) {
                this.selectedCounter.style.display = 'inline-block';
            } else {
                this.selectedCounter.style.display = 'none';
            }
        }

        if (this.actionsDropdown) {
            this.actionsDropdown.disabled = count === 0;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –¥—Ä–æ–ø–¥–∞—É–Ω–µ, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        const selectedCountBadge = document.getElementById('selectedCount');
        if (selectedCountBadge) {
            selectedCountBadge.textContent = count;
        }

        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —Ñ–æ—Ä–º–µ –∞–¥–º–∏–Ω–∫–∏, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        const actionCounter = document.querySelector('.action-counter');
        if (actionCounter) {
            const total = this.tree.querySelectorAll('input[name="_selected_action"]').length;
            const selected = this.tree.querySelectorAll('input[name="_selected_action"]:checked').length;
            actionCounter.textContent = `${selected} –∏–∑ ${total} –≤—ã–±—Ä–∞–Ω–æ`;
            actionCounter.style.display = selected > 0 ? 'inline' : 'none';
        }
    }

    /**
     * üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏–π —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏
     */
    _initEmployeeActions() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        const btnIssueCard = document.getElementById('btnIssueCard');
        const btnIssueSIZ = document.getElementById('btnIssueSIZ');
        const btnEditEmployee = document.getElementById('btnEditEmployee');

        if (btnIssueCard) {
            btnIssueCard.addEventListener('click', () => {
                if (this.selectedEmployees.length === 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ—Ç–∞.');
                    return;
                }

                if (this.selectedEmployees.length > 1) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ—Ç–∞.');
                    return;
                }

                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                const employeeId = this.selectedEmployees[0];
                const url = document.querySelector('[data-siz-personal-card-url]')?.dataset.sizPersonalCardUrl || '';
                window.location.href = url.replace('0', employeeId);
            });
        }

        if (btnIssueSIZ) {
            btnIssueSIZ.addEventListener('click', () => {
                if (this.selectedEmployees.length === 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –≤—ã–¥–∞—á–∏ –°–ò–ó.');
                    return;
                }

                if (this.selectedEmployees.length > 1) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –≤—ã–¥–∞—á–∏ –°–ò–ó.');
                    return;
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                const employeeId = this.selectedEmployees[0];
                const url = document.querySelector('[data-siz-issue-url]')?.dataset.sizIssueUrl || '';
                window.location.href = url.replace('0', employeeId);
            });
        }

        if (btnEditEmployee) {
            btnEditEmployee.addEventListener('click', () => {
                if (this.selectedEmployees.length === 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
                    return;
                }

                if (this.selectedEmployees.length > 1) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
                    return;
                }

                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                const employeeId = this.selectedEmployees[0];
                const url = document.querySelector('[data-employee-update-url]')?.dataset.employeeUpdateUrl || '';
                window.location.href = url.replace('0', employeeId);
            });
        }
    }
}

// –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    window.treeCore = new TreeCore();
});