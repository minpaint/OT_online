{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">{{ title }}</h1>

    <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div class="mb-3">
        <a href="{% url 'directory:commissions:commission_create' %}" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–∏—Å—Å–∏—é
        </a>
        <a href="{% url 'directory:commissions:commission_list' %}" class="btn btn-outline-primary ms-2">
            <i class="fas fa-list"></i> –°–ø–∏—Å–æ–∫ –∫–æ–º–∏—Å—Å–∏–π
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            {% if tree_data %}
                <div class="commission-tree">
                    {% for org in tree_data %}
                        <div class="org-node mb-3">
                            <!-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
                            <div class="tree-node org-level">
                                <div class="node-toggle" data-bs-toggle="collapse" data-bs-target="#org-{{ org.id }}" aria-expanded="true">
                                    <i class="fas fa-caret-down toggle-icon"></i>
                                    <span class="node-icon">{{ org.icon }}</span>
                                    <span class="node-text">{{ org.name }}</span>
                                </div>
                            </div>

                            <div id="org-{{ org.id }}" class="collapse show">
                                <!-- –ö–æ–º–∏—Å—Å–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
                                {% if org.commissions %}
                                    <div class="commission-list">
                                        {% for commission in org.commissions %}
                                            <div class="tree-node commission-node {% if not commission.is_active %}inactive{% endif %}">
                                                <div class="node-toggle" data-bs-toggle="collapse" data-bs-target="#commission-{{ commission.id }}" aria-expanded="false">
                                                    <i class="fas fa-caret-right toggle-icon"></i>
                                                    <span class="node-icon">{{ commission.icon }}</span>
                                                    <a href="{% url 'directory:commissions:commission_detail' commission.id %}" class="node-text">
                                                        {{ commission.name }}
                                                        {% if not commission.is_active %}<span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>{% endif %}
                                                    </a>
                                                </div>

                                                <div id="commission-{{ commission.id }}" class="collapse">
                                                    <div class="commission-members">
                                                        {% if commission.chairman %}
                                                            <div class="member chairman">
                                                                <span class="role-icon">üëë</span>
                                                                <span class="member-name">{{ commission.chairman.name }}</span>
                                                                <span class="member-position">{{ commission.chairman.position }}</span>
                                                            </div>
                                                        {% else %}
                                                            <div class="member missing">
                                                                <span class="role-icon">üëë</span>
                                                                <span class="missing-text">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                                                <a href="{% url 'directory:commissions:commission_member_add' commission.id %}?role=chairman" class="btn btn-sm btn-outline-success">
                                                                    –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                                                </a>
                                                            </div>
                                                        {% endif %}

                                                        {% if commission.secretary %}
                                                            <div class="member secretary">
                                                                <span class="role-icon">üìù</span>
                                                                <span class="member-name">{{ commission.secretary.name }}</span>
                                                                <span class="member-position">{{ commission.secretary.position }}</span>
                                                            </div>
                                                        {% else %}
                                                            <div class="member missing">
                                                                <span class="role-icon">üìù</span>
                                                                <span class="missing-text">–°–µ–∫—Ä–µ—Ç–∞—Ä—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                                                <a href="{% url 'directory:commissions:commission_member_add' commission.id %}?role=secretary" class="btn btn-sm btn-outline-success">
                                                                    –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                                                </a>
                                                            </div>
                                                        {% endif %}

                                                        {% if commission.members %}
                                                            {% for member in commission.members %}
                                                                <div class="member">
                                                                    <span class="role-icon">üë§</span>
                                                                    <span class="member-name">{{ member.name }}</span>
                                                                    <span class="member-position">{{ member.position }}</span>
                                                                </div>
                                                            {% endfor %}
                                                        {% else %}
                                                            <div class="member missing">
                                                                <span class="role-icon">üë§</span>
                                                                <span class="missing-text">–ù–µ—Ç —á–ª–µ–Ω–æ–≤ –∫–æ–º–∏—Å—Å–∏–∏</span>
                                                                <a href="{% url 'directory:commissions:commission_member_add' commission.id %}?role=member" class="btn btn-sm btn-outline-success">
                                                                    –î–æ–±–∞–≤–∏—Ç—å
                                                                </a>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <!-- –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
                                {% for subdivision in org.subdivisions %}
                                    <div class="subdiv-node">
                                        <!-- –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ -->
                                        <div class="tree-node subdiv-level">
                                            <div class="node-toggle" data-bs-toggle="collapse" data-bs-target="#subdiv-{{ subdivision.id }}" aria-expanded="false">
                                                <i class="fas fa-caret-right toggle-icon"></i>
                                                <span class="node-icon">{{ subdivision.icon }}</span>
                                                <span class="node-text">{{ subdivision.name }}</span>
                                            </div>
                                        </div>

                                        <div id="subdiv-{{ subdivision.id }}" class="collapse">
                                            <!-- –ö–æ–º–∏—Å—Å–∏–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
                                            {% if subdivision.commissions %}
                                                <div class="commission-list">
                                                    {% for commission in subdivision.commissions %}
                                                        <div class="tree-node commission-node {% if not commission.is_active %}inactive{% endif %}">
                                                            <div class="node-toggle" data-bs-toggle="collapse" data-bs-target="#commission-{{ commission.id }}" aria-expanded="false">
                                                                <i class="fas fa-caret-right toggle-icon"></i>
                                                                <span class="node-icon">{{ commission.icon }}</span>
                                                                <a href="{% url 'directory:commissions:commission_detail' commission.id %}" class="node-text">
                                                                    {{ commission.name }}
                                                                    {% if not commission.is_active %}<span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>{% endif %}
                                                                </a>
                                                            </div>

                                                            <div id="commission-{{ commission.id }}" class="collapse">
                                                                <div class="commission-members">
                                                                    {% if commission.chairman %}
                                                                        <div class="member chairman">
                                                                            <span class="role-icon">üëë</span>
                                                                            <span class="member-name">{{ commission.chairman.name }}</span>
                                                                            <span class="member-position">{{ commission.chairman.position }}</span>
                                                                        </div>
                                                                    {% else %}
                                                                        <div class="member missing">
                                                                            <span class="role-icon">üëë</span>
                                                                            <span class="missing-text">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                                                            <a href="{% url 'directory:commissions:commission_member_add' commission.id %}?role=chairman" class="btn btn-sm btn-outline-success">
                                                                                –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                                                            </a>
                                                                        </div>
                                                                    {% endif %}

                                                                    {% if commission.secretary %}
                                                                        <div class="member secretary">
                                                                            <span class="role-icon">üìù</span>
                                                                            <span class="member-name">{{ commission.secretary.name }}</span>
                                                                            <span class="member-position">{{ commission.secretary.position }}</span>
                                                                        </div>
                                                                    {% else %}
                                                                        <div class="member missing">
                                                                            <span class="role-icon">üìù</span>
                                                                            <span class="missing-text">–°–µ–∫—Ä–µ—Ç–∞—Ä—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                                                            <a href="{% url 'directory:commissions:commission_member_add' commission.id %}?role=secretary" class="btn btn-sm btn-outline-success">
                                                                                –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                                                            </a>
                                                                        </div>
                                                                    {% endif %}

                                                                    {% if commission.members %}
                                                                        {% for member in commission.members %}
                                                                            <div class="member">
                                                                                <span class="role-icon">üë§</span>
                                                                                <span class="member-name">{{ member.name }}</span>
                                                                                <span class="member-position">{{ member.position }}</span>
                                                                            </div>
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <div class="member missing">
                                                                            <span class="role-icon">üë§</span>
                                                                            <span class="missing-text">–ù–µ—Ç —á–ª–µ–Ω–æ–≤ –∫–æ–º–∏—Å—Å–∏–∏</span>
                                                                            <a href="{% url 'directory:commissions:commission_member_add' commission.id %}?role=member" class="btn btn-sm btn-outline-success">
                                                                                –î–æ–±–∞–≤–∏—Ç—å
                                                                            </a>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}

                                            <!-- –û—Ç–¥–µ–ª—ã -->
                                            {% for department in subdivision.departments %}
                                                <div class="dept-node">
                                                    <!-- –û—Ç–¥–µ–ª -->
                                                    <div class="tree-node dept-level">
                                                        <div class="node-toggle" data-bs-toggle="collapse" data-bs-target="#dept-{{ department.id }}" aria-expanded="false">
                                                            <i class="fas fa-caret-right toggle-icon"></i>
                                                            <span class="node-icon">{{ department.icon }}</span>
                                                            <span class="node-text">{{ department.name }}</span>
                                                        </div>
                                                    </div>

                                                    <div id="dept-{{ department.id }}" class="collapse">
                                                        <!-- –ö–æ–º–∏—Å—Å–∏–∏ –æ—Ç–¥–µ–ª–∞ -->
                                                        {% if department.commissions %}
                                                            <div class="commission-list">
                                                                {% for commission in department.commissions %}
                                                                    <div class="tree-node commission-node {% if not commission.is_active %}inactive{% endif %}">
                                                                        <div class="node-toggle" data-bs-toggle="collapse" data-bs-target="#commission-{{ commission.id }}" aria-expanded="false">
                                                                            <i class="fas fa-caret-right toggle-icon"></i>
                                                                            <span class="node-icon">{{ commission.icon }}</span>
                                                                            <a href="{% url 'directory:commissions:commission_detail' commission.id %}" class="node-text">
                                                                                {{ commission.name }}
                                                                                {% if not commission.is_active %}<span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>{% endif %}
                                                                            </a>
                                                                        </div>

                                                                        <div id="commission-{{ commission.id }}" class="collapse">
                                                                            <div class="commission-members">
                                                                                {% if commission.chairman %}
                                                                                    <div class="member chairman">
                                                                                        <span class="role-icon">üëë</span>
                                                                                        <span class="member-name">{{ commission.chairman.name }}</span>
                                                                                        <span class="member-position">{{ commission.chairman.position }}</span>
                                                                                    </div>
                                                                                {% else %}
                                                                                    <div class="member missing">
                                                                                        <span class="role-icon">üëë</span>
                                                                                        <span class="missing-text">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                                                                        <a href="{% url 'directory:commissions:commission_member_add' commission.id %}?role=chairman" class="btn btn-sm btn-outline-success">
                                                                                            –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                                                                        </a>
                                                                                    </div>
                                                                                {% endif %}

                                                                                {% if commission.secretary %}
                                                                                    <div class="member secretary">
                                                                                        <span class="role-icon">üìù</span>
                                                                                        <span class="member-name">{{ commission.secretary.name }}</span>
                                                                                        <span class="member-position">{{ commission.secretary.position }}</span>
                                                                                    </div>
                                                                                {% else %}
                                                                                    <div class="member missing">
                                                                                        <span class="role-icon">üìù</span>
                                                                                        <span class="missing-text">–°–µ–∫—Ä–µ—Ç–∞—Ä—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                                                                        <a href="{% url 'directory:commissions:commission_member_add' commission.id %}?role=secretary" class="btn btn-sm btn-outline-success">
                                                                                            –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                                                                        </a>
                                                                                    </div>
                                                                                {% endif %}

                                                                                {% if commission.members %}
                                                                                    {% for member in commission.members %}
                                                                                        <div class="member">
                                                                                            <span class="role-icon">üë§</span>
                                                                                            <span class="member-name">{{ member.name }}</span>
                                                                                            <span class="member-position">{{ member.position }}</span>
                                                                                        </div>
                                                                                    {% endfor %}
                                                                                {% else %}
                                                                                    <div class="member missing">
                                                                                        <span class="role-icon">üë§</span>
                                                                                        <span class="missing-text">–ù–µ—Ç —á–ª–µ–Ω–æ–≤ –∫–æ–º–∏—Å—Å–∏–∏</span>
                                                                                        <a href="{% url 'directory:commissions:commission_member_add' commission.id %}?role=member" class="btn btn-sm btn-outline-success">
                                                                                            –î–æ–±–∞–≤–∏—Ç—å
                                                                                        </a>
                                                                                    </div>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        {% else %}
                                                            <div class="no-commissions">
                                                                <span class="text-muted">–ù–µ—Ç –∫–æ–º–∏—Å—Å–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ—Ç–¥–µ–ª–∞</span>
                                                                <a href="{% url 'directory:commissions:commission_create' %}" class="btn btn-sm btn-outline-success">
                                                                    –°–æ–∑–¥–∞—Ç—å
                                                                </a>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <h4 class="alert-heading">–ö–æ–º–∏—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                    <p>–í —Å–∏—Å—Ç–µ–º–µ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–Ω–∞–Ω–∏–π.</p>
                    <hr>
                    <p class="mb-0">–í—ã –º–æ–∂–µ—Ç–µ <a href="{% url 'directory:commissions:commission_create' %}" class="alert-link">—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–∏—Å—Å–∏—é</a>.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .commission-tree {
        padding-left: 0;
    }

    .tree-node {
        margin: 5px 0;
        padding: 5px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .tree-node:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .org-level {
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
    }

    .subdiv-level {
        margin-left: 20px;
        background-color: #f8f9fa;
        border-left: 4px solid #6610f2;
    }

    .dept-level {
        margin-left: 40px;
        background-color: #f8f9fa;
        border-left: 4px solid #20c997;
    }

    .commission-node {
        margin-left: 20px;
        background-color: #fff;
        border-left: 4px solid #fd7e14;
    }

    .commission-node.inactive {
        opacity: 0.7;
        border-left: 4px solid #6c757d;
    }

    .commission-members {
        margin-left: 40px;
        padding: 5px 0;
    }

    .member {
        padding: 5px;
        margin: 5px 0;
        border-radius: 4px;
        display: flex;
        align-items: center;
    }

    .member.chairman {
        background-color: rgba(255, 193, 7, 0.1);
    }

    .member.secretary {
        background-color: rgba(13, 110, 253, 0.1);
    }

    .member.missing {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    .role-icon {
        margin-right: 10px;
        font-size: 1.2em;
    }

    .member-name {
        font-weight: 500;
        margin-right: 10px;
    }

    .member-position {
        color: #6c757d;
        font-size: 0.9em;
    }

    .missing-text {
        font-style: italic;
        margin-right: 10px;
    }

    .node-toggle {
        cursor: pointer;
        display: flex;
        align-items: center;
    }

    .toggle-icon {
        margin-right: 10px;
        transition: transform 0.2s;
    }

    .collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .node-icon {
        margin-right: 10px;
        font-size: 1.2em;
    }

    .node-text {
        font-weight: 500;
    }

    .commission-list {
        margin-left: 20px;
    }

    .no-commissions {
        margin-left: 20px;
        padding: 10px;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —É–∑–ª–æ–≤
        $('.node-toggle').on('click', function() {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∏–∫–æ–Ω–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ
            $(this).find('.toggle-icon').toggleClass('fa-caret-right fa-caret-down');
        });

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏,
        // –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–∑–ª—ã –¥–µ–ª–∞–µ–º —Å–≤–µ—Ä–Ω—É—Ç—ã–º–∏
        $('.org-level .node-toggle').each(function() {
            $(this).find('.toggle-icon').removeClass('fa-caret-right').addClass('fa-caret-down');
        });

        $('.subdiv-level .node-toggle, .dept-level .node-toggle, .commission-node .node-toggle').each(function() {
            $(this).find('.toggle-icon').removeClass('fa-caret-down').addClass('fa-caret-right');
        });

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º "–≤—Å–ø–ª—ã—Ç–∏–µ" —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–∫–∞ –ø–æ —Å—Å—ã–ª–∫–∞–º –≤–Ω—É—Ç—Ä–∏ —É–∑–ª–æ–≤
        $('.node-text a, .member a').on('click', function(e) {
            e.stopPropagation();
        });
    });
</script>
{% endblock %}