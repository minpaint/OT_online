{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* üé® –°—Ç–∏–ª–∏ –¥–ª—è –ª–∏—á–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ—Ç–∞ –°–ò–ó */
    .card-header {
        background-color: #f5f5f5;
        padding: 1rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .siz-card-header {
        background-color: #007bff;
        color: white;
        padding: 0.5rem 1rem;
        font-weight: bold;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
    }

    .siz-group {
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }

    .siz-group-header {
        padding: 0.75rem 1rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
    }

    .siz-table th {
        background-color: #f8f9fa;
    }

    .siz-table-container {
        overflow-x: auto;
    }

    .nav-link.active {
        background-color: #007bff !important;
        color: white !important;
    }

    .badge-active {
        background-color: #28a745;
        color: white;
    }

    .badge-returned {
        background-color: #dc3545;
        color: white;
    }

    .print-btn {
        margin-bottom: 1rem;
    }

    /* üñ®Ô∏è –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ */
    @media print {
        .no-print {
            display: none !important;
        }

        .container {
            width: 100%;
            max-width: 100%;
        }

        .card {
            border: none !important;
        }

        .card-header {
            border-bottom: 1px solid #000 !important;
        }

        .table {
            border-collapse: collapse !important;
        }

        .table td,
        .table th {
            border: 1px solid #000 !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>

    <div class="row mb-3 no-print">
        <div class="col-md-6">
            <a href="{% url 'directory:siz:siz_issue_for_employee' employee.id %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> –í—ã–¥–∞—Ç—å –Ω–æ–≤—ã–µ –°–ò–ó
            </a>
            <button onclick="window.print()" class="btn btn-secondary ml-2">
                <i class="fas fa-print"></i> –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
            </button>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>–§–ò–û:</strong> {{ employee.full_name_nominative }}</p>
                    <p><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ employee.date_of_birth|date:"d.m.Y" }}</p>
                    {% if employee.place_of_residence %}
                    <p><strong>–ú–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è:</strong> {{ employee.place_of_residence }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <p><strong>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</strong> {{ employee.organization }}</p>
                    {% if employee.subdivision %}
                    <p><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> {{ employee.subdivision }}</p>
                    {% endif %}
                    {% if employee.department %}
                    <p><strong>–û—Ç–¥–µ–ª:</strong> {{ employee.department }}</p>
                    {% endif %}
                    {% if employee.position %}
                    <p><strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> {{ employee.position }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º -->
    <ul class="nav nav-tabs mb-3 no-print" id="sizTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="norms-tab" data-toggle="tab" href="#norms" role="tab" aria-controls="norms"
                aria-selected="true">–õ–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (–ù–æ—Ä–º—ã –≤—ã–¥–∞—á–∏)</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="issued-tab" data-toggle="tab" href="#issued" role="tab" aria-controls="issued"
                aria-selected="false">–û–±–æ—Ä–æ—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (–í—ã–¥–∞–Ω–Ω—ã–µ –°–ò–ó)
                <span class="badge badge-primary">{{ issued_items.count }}</span>
            </a>
        </li>
    </ul>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-content" id="sizTabsContent">
        <!-- –í–∫–ª–∞–¥–∫–∞ "–ù–æ—Ä–º—ã –≤—ã–¥–∞—á–∏" (–õ–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞) -->
        <div class="tab-pane fade show active" id="norms" role="tabpanel" aria-labelledby="norms-tab">
            <div class="card">
                <div class="siz-card-header">
                    –õ–ò–ß–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê ‚Ññ {{ employee.id }}
                    —É—á–µ—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã
                </div>
                <div class="card-body">
                    <div class="siz-group">
                        <div class="siz-group-header">–û—Å–Ω–æ–≤–Ω—ã–µ –°–ò–ó</div>
                        <div class="siz-table-container">
                            <table class="table table-bordered siz-table">
                                <thead>
                                    <tr>
                                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã</th>
                                        <th>–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞)</th>
                                        <th>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                        <th>–°—Ä–æ–∫ –Ω–æ—Å–∫–∏ –≤ –º–µ—Å—è—Ü–∞—Ö</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for norm in base_norms %}
                                    <tr>
                                        <td>{{ norm.siz.name }}</td>
                                        <td>{{ norm.siz.classification }}</td>
                                        <td>{{ norm.siz.unit }}</td>
                                        <td>{{ norm.quantity }}</td>
                                        <td>
                                            {% if norm.siz.wear_period == 0 %}
                                            –î–æ –∏–∑–Ω–æ—Å–∞
                                            {% else %}
                                            {{ norm.siz.wear_period }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">–ù–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –Ω–æ—Ä–º –°–ò–ó</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {% for group in condition_groups %}
                    <div class="siz-group">
                        <div class="siz-group-header">{{ group.name }}</div>
                        <div class="siz-table-container">
                            <table class="table table-bordered siz-table">
                                <thead>
                                    <tr>
                                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã</th>
                                        <th>–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞)</th>
                                        <th>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                        <th>–°—Ä–æ–∫ –Ω–æ—Å–∫–∏ –≤ –º–µ—Å—è—Ü–∞—Ö</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for norm in group.norms %}
                                    <tr>
                                        <td>{{ norm.siz.name }}</td>
                                        <td>{{ norm.siz.classification }}</td>
                                        <td>{{ norm.siz.unit }}</td>
                                        <td>{{ norm.quantity }}</td>
                                        <td>
                                            {% if norm.siz.wear_period == 0 %}
                                            –î–æ –∏–∑–Ω–æ—Å–∞
                                            {% else %}
                                            {{ norm.siz.wear_period }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">–ù–µ—Ç –Ω–æ—Ä–º –°–ò–ó –¥–ª—è —ç—Ç–æ–≥–æ —É—Å–ª–æ–≤–∏—è</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ "–í—ã–¥–∞–Ω–Ω—ã–µ –°–ò–ó" (–û–±–æ—Ä–æ—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞) -->
        <div class="tab-pane fade" id="issued" role="tabpanel" aria-labelledby="issued-tab">
            <div class="card">
                <div class="siz-card-header">
                    –õ–ò–ß–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê ‚Ññ {{ employee.id }}
                    —É—á–µ—Ç–∞ –≤—ã–¥–∞—á–∏ —Å—Ä–µ–¥—Å—Ç–≤ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã (–æ–±–æ—Ä–æ—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)
                </div>
                <div class="card-body">
                    <div class="siz-table-container">
                        <table class="table table-bordered siz-table">
                            <thead>
                                <tr>
                                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –°–ò–ó</th>
                                    <th>–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</th>
                                    <th>–í—ã–¥–∞–Ω–æ</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
                                    <th>–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ</th>
                                    <th class="no-print">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in issued_items %}
                                <tr>
                                    <td>{{ item.siz.name }}</td>
                                    <td>{{ item.siz.classification }}</td>
                                    <td>{{ item.issue_date|date:"d.m.Y" }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>
                                        {% if item.is_returned %}
                                        <span class="badge badge-secondary">–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ</span>
                                        {% else %}
                                        <span class="badge" style="background-color: 
                                            {% if item.wear_percentage < 30 %}#28a745{% elif item.wear_percentage < 70 %}#ffc107{% else %}#dc3545{% endif %}; 
                                            color: white;">
                                            {{ item.wear_percentage }}% –∏–∑–Ω–æ—Å–∞
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.is_returned %}
                                        {{ item.return_date|date:"d.m.Y" }}
                                        {% else %}
                                        <span class="badge badge-active">–í –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏</span>
                                        {% endif %}
                                    </td>
                                    <td class="no-print">
                                        {% if not item.is_returned %}
                                        <a href="{% url 'directory:siz:siz_return' item.id %}" class="btn btn-warning btn-sm">
                                            <i class="fas fa-undo"></i> –í–µ—Ä–Ω—É—Ç—å
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">–ù–µ—Ç –≤—ã–¥–∞–Ω–Ω—ã—Ö –°–ò–ó</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ (–ø—Ä–∏ –ø–µ—á–∞—Ç–∏) -->
    <div class="d-none d-print-block mt-5">
        <div class="row">
            <div class="col-6">
                <p>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ____________________ ({{ employee.full_name_nominative }})</p>
            </div>
            <div class="col-6">
                <p>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –ª–∏—Ü–æ ____________________ (_____________________)</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // üìä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ Bootstrap –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —è–∫–æ—Ä—å –≤ URL (#norms –∏–ª–∏ #issued)
        const hash = window.location.hash;
        if (hash) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —è–∫–æ—Ä—å, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –≤–∫–ª–∞–¥–∫—É
            const tab = document.querySelector(`a[href="${hash}"]`);
            if (tab) {
                tab.click();
            }
        }
    });
</script>
{% endblock %}