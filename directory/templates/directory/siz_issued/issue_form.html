{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* üé® –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –°–ò–ó –ø–æ —É—Å–ª–æ–≤–∏—è–º */
    .siz-group {
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    
    .siz-group-header {
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
    }
    
    .siz-group-body {
        padding: 15px;
    }
    
    .siz-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .siz-item:last-child {
        border-bottom: none;
    }
    
    .siz-item:hover {
        background-color: #f8f9fa;
    }
    
    .siz-checkbox-label {
        font-weight: 500;
    }
    
    .siz-details {
        display: none;
        padding: 10px 0 0 25px;
    }
    
    .siz-details.visible {
        display: block;
    }
    
    /* üõ°Ô∏è –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –°–ò–ó */
    .siz-status-icon {
        margin-right: 5px;
    }
    
    .wear-good {
        color: #28a745;
    }
    
    .wear-medium {
        color: #ffc107;
    }
    
    .wear-bad {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ</h3>
        </div>
        <div class="card-body">
            {% if employee %}
            <div class="row">
                <div class="col-md-6">
                    <p><strong>–§–ò–û:</strong> {{ employee.full_name_nominative }}</p>
                    <p><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ employee.date_of_birth|date:"d.m.Y" }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</strong> {{ employee.organization }}</p>
                    {% if employee.subdivision %}
                    <p><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> {{ employee.subdivision }}</p>
                    {% endif %}
                    {% if employee.department %}
                    <p><strong>–û—Ç–¥–µ–ª:</strong> {{ employee.department }}</p>
                    {% endif %}
                    {% if employee.position %}
                    <p><strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> {{ employee.position }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <form method="post" id="siz-issue-form">
        {% csrf_token %}
        {% crispy form %}
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('siz-issue-form');
        const employeeSelect = document.getElementById('id_employee');
        const groupsContainer = document.getElementById('siz-groups-container');
        
        // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        if (employeeSelect) {
            employeeSelect.addEventListener('change', function() {
                form.submit();
            });
        }
        
        // üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –°–ò–ó
        const sizCheckboxes = document.querySelectorAll('.siz-select');
        sizCheckboxes.forEach(function(checkbox) {
            const normId = checkbox.dataset.normId;
            const detailsDiv = document.querySelector(`.siz-details[data-norm-id="${normId}"]`);
            
            // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞
            if (detailsDiv) {
                detailsDiv.classList.toggle('visible', checkbox.checked);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
            checkbox.addEventListener('change', function() {
                if (detailsDiv) {
                    detailsDiv.classList.toggle('visible', this.checked);
                }
            });
        });
        
        // üìã –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –°–ò–ó –ø–æ —É—Å–ª–æ–≤–∏—è–º
        const sizItems = Array.from(document.querySelectorAll('.siz-select'));
        const conditions = {};
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É—Å–ª–æ–≤–∏—è –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö
        sizItems.forEach(function(item) {
            const condition = item.dataset.condition || '–û—Å–Ω–æ–≤–Ω—ã–µ –°–ò–ó';
            if (!conditions[condition]) {
                conditions[condition] = [];
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π div (—Å–æ–¥–µ—Ä–∂–∞—â–∏–π —á–µ–∫–±–æ–∫—Å –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–ª—è)
            let sizItem = item.closest('.form-group');
            if (!sizItem) {
                sizItem = item.closest('.row');
            }
            
            if (sizItem) {
                conditions[condition].push(sizItem);
            }
        });
        
        // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å–ª–æ–≤–∏—è
        if (groupsContainer) {
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≥—Ä—É–ø–ø
            groupsContainer.innerHTML = '';
            
            Object.keys(conditions).forEach(function(condition) {
                const items = conditions[condition];
                if (items.length > 0) {
                    // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É
                    const group = document.createElement('div');
                    group.className = 'siz-group mb-4';
                    
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã
                    const header = document.createElement('div');
                    header.className = 'siz-group-header';
                    header.textContent = condition;
                    
                    // –¢–µ–ª–æ –≥—Ä—É–ø–ø—ã
                    const body = document.createElement('div');
                    body.className = 'siz-group-body';
                    
                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –≥—Ä—É–ø–ø—É
                    items.forEach(function(item) {
                        const container = item.parentNode;
                        const clone = item.cloneNode(true);
                        body.appendChild(clone);
                        
                        // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–∞
                        if (container && container.contains(item)) {
                            container.removeChild(item);
                        }
                    });
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –≥—Ä—É–ø–ø—É
                    group.appendChild(header);
                    group.appendChild(body);
                    groupsContainer.appendChild(group);
                }
            });
        }
    });
</script>
{% endblock %}