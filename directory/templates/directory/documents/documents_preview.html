{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load document_filters %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .document-preview {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
    }
    
    .document-title {
        font-weight: bold;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .editable-field {
        background-color: #f8f9fa;
        border: 1px dashed #ced4da;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        margin: 0.25rem 0;
        display: block;
    }

    .editable-field:hover {
        background-color: #e9ecef;
    }

    .missing-data-warning {
        background-color: #fff3cd;
        border-color: #ffecb5;
        color: #664d03;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'directory:home' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'directory:documents:document_list' %}">–î–æ–∫—É–º–µ–Ω—Ç—ã</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ title }}</h4>
                </div>
                <div class="card-body">
                    {% if employee %}
                    <div class="alert alert-info mb-4">
                        <h5>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>–§–ò–û:</strong> {{ employee.full_name_nominative }}</p>
                                <p><strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> {{ employee.position.position_name }}</p>
                            </div>
                            <div class="col-md-6">
                                {% if employee.department %}
                                <p><strong>–û—Ç–¥–µ–ª:</strong> {{ employee.department.name }}</p>
                                {% endif %}
                                {% if employee.subdivision %}
                                <p><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> {{ employee.subdivision.name }}</p>
                                {% endif %}
                                <p><strong>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</strong> {{ employee.organization.short_name_ru }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <form method="post" action="">
                        {% csrf_token %}
                        
                        {% if preview_data %}
                            <div class="accordion" id="documentsAccordion">
                                {% for doc_data in preview_data %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" 
                                                    aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                                                    aria-controls="collapse{{ forloop.counter }}">
                                                {% if document_types_dict %}
                                                    {{ document_types_dict|get_item:doc_data.document_type|default:doc_data.document_type }}
                                                {% else %}
                                                    {% if doc_data.document_type == 'internship_order' %}
                                                        –†–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–µ –æ —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–µ
                                                    {% elif doc_data.document_type == 'admission_order' %}
                                                        –†–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–µ –æ –¥–æ–ø—É—Å–∫–µ –∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ
                                                    {% elif doc_data.document_type == 'knowledge_protocol' %}
                                                        –ü—Ä–æ—Ç–æ–∫–æ–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π
                                                    {% elif doc_data.document_type == 'doc_familiarization' %}
                                                        –õ–∏—Å—Ç –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
                                                    {% else %}
                                                        {{ doc_data.document_type }}
                                                    {% endif %}
                                                {% endif %}
                                            </button>
                                        </h2>
                                        <div id="collapse{{ forloop.counter }}" 
                                             class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                                             aria-labelledby="heading{{ forloop.counter }}" 
                                             data-bs-parent="#documentsAccordion">
                                            <div class="accordion-body">
                                                {% if doc_data.document_data.has_missing_data %}
                                                    <div class="alert alert-warning missing-data-warning">
                                                        <h5><i class="fas fa-exclamation-triangle"></i> –í–Ω–∏–º–∞–Ω–∏–µ! –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:</h5>
                                                        <ul>
                                                            {% for item in doc_data.document_data.missing_data %}
                                                                <li>{{ item }}</li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endif %}

                                                <div class="document-data-form">
                                                    {% for key, value in doc_data.document_data.items %}
                                                        {% if key != 'missing_data' and key != 'has_missing_data' %}
                                                            <div class="mb-3 row">
                                                                <label class="col-sm-4 col-form-label">{{ key }}:</label>
                                                                <div class="col-sm-8">
                                                                    <input type="text" 
                                                                           class="form-control document-field" 
                                                                           name="document_data_{{ doc_data.document_type }}_{{ key }}" 
                                                                           value="{{ value }}"
                                                                           data-doc-type="{{ doc_data.document_type }}"
                                                                           data-field-name="{{ key }}">
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                {% if employee %}
                                    <a href="{% url 'directory:documents:document_selection' employee_id=employee.id %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                                    </a>
                                {% else %}
                                    <a href="{% url 'directory:home' %}" class="btn btn-secondary">
                                        <i class="fas fa-home"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
                                    </a>
                                {% endif %}
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-file-download"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
                                </button>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
                            </div>
                            
                            <div class="d-flex justify-content-center mt-4">
                                <a href="{% url 'directory:home' %}" class="btn btn-primary">
                                    <i class="fas fa-home"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
                                </a>
                            </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // AJAX –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
        const documentFields = document.querySelectorAll('.document-field');
        documentFields.forEach(field => {
            field.addEventListener('change', function() {
                const docType = this.getAttribute('data-doc-type');
                const fieldName = this.getAttribute('data-field-name');
                const fieldValue = this.value;

                fetch('{% url "directory:documents:update_preview_data" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
                    },
                    body: `doc_type=${docType}&field_name=${fieldName}&field_value=${fieldValue}`
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', data.error);
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:', error);
                });
            });
        });
    });
</script>
{% endblock %}