{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π CSS —Ñ–∞–π–ª –¥–ª—è —Å—Ç–∏–ª–µ–π –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã -->
<link rel="stylesheet" href="{% static 'directory/css/tree_view.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- üéØ –ü–∞–Ω–µ–ª—å —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ -->
    <div class="actions-bar">
        <button id="btnExpandAll" class="btn btn-sm btn-outline-secondary me-2">
            <i class="fas fa-expand-alt"></i> –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ
        </button>
        <button id="btnCollapseAll" class="btn btn-sm btn-outline-secondary me-2">
            <i class="fas fa-compress-alt"></i> –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ
        </button>
        <div class="dropdown d-inline-block me-2">
            <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="actionsDropdown" 
                    data-bs-toggle="dropdown" aria-expanded="false" disabled>
                –î–µ–π—Å—Ç–≤–∏—è <span id="selectedCount" class="badge bg-light text-dark ms-1">0</span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="actionsDropdown">
                <li><a class="dropdown-item" href="#" id="btnIssueCard">
                    <i class="fas fa-id-card"></i> –ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ—Ç–∞
                </a></li>
                <li><a class="dropdown-item" href="#" id="btnIssueSIZ">
                    <i class="fas fa-hard-hat"></i> –í—ã–¥–∞—Ç—å –°–ò–ó
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="btnEditEmployee">
                    <i class="fas fa-user-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </a></li>
            </ul>
        </div>
        
        <button id="btnHireEmployee" class="btn btn-success btn-sm ms-auto">
            <i class="fas fa-user-plus"></i> –ü—Ä–∏–Ω—è—Ç—å –Ω–∞ —Ä–∞–±–æ—Ç—É
        </button>
        
        <div id="selectedCounter" class="select-count text-muted" style="display: none;">
            –í—ã–±—Ä–∞–Ω–æ: <span id="counterValue">0</span>
        </div>
    </div>

    <!-- üìã –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
    <div class="table-responsive mt-2">
        <table class="tree-table table table-hover" id="employeeTree">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="custom-checkbox" id="selectAll">
                    </th>
                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for organization in organizations %}
                    <!-- üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
                    <tr class="tree-row organization-row" data-level="0" data-node-id="org-{{ organization.id }}">
                        <td>
                            <input type="checkbox" class="custom-checkbox org-checkbox" 
                                   data-id="org-{{ organization.id }}">
                        </td>
                        <td>
                            <span class="tree-toggle" data-node="org-{{ organization.id }}">-</span>
                            <span class="tree-icon">üè¢</span> {{ organization.name }}
                        </td>
                        <td></td>
                        <td></td>
                    </tr>
                    
                    <!-- üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–±–µ–∑ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è) -->
                    {% for employee in organization.employees %}
                        <tr class="tree-row" data-level="1" data-parent="org-{{ organization.id }}">
                            <td>
                                <input type="checkbox" class="custom-checkbox employee-checkbox" 
                                       data-id="{{ employee.id }}" data-type="employee">
                            </td>
                            <td>
                                <div class="tree-level">
                                    <span class="tree-icon">üë§</span> {{ employee.full_name_nominative }}
                                </div>
                            </td>
                            <td>{{ employee.position.position_name }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'directory:employees:employee_update' employee.pk %}" 
                                       class="btn btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'directory:siz:siz_personal_card' employee.id %}" 
                                       class="btn btn-outline-info">
                                        <i class="fas fa-id-card"></i>
                                    </a>
                                    <a href="{% url 'directory:siz:siz_issue_for_employee' employee.id %}" 
                                       class="btn btn-outline-success">
                                        <i class="fas fa-hard-hat"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    
                    <!-- üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
                    {% for subdivision in organization.subdivisions %}
                        <tr class="tree-row subdivision-row" data-level="1" 
                            data-parent="org-{{ organization.id }}" 
                            data-node-id="sub-{{ subdivision.id }}">
                            <td>
                                <input type="checkbox" class="custom-checkbox sub-checkbox" 
                                       data-id="sub-{{ subdivision.id }}">
                            </td>
                            <td>
                                <div class="tree-level">
                                    <span class="tree-toggle" data-node="sub-{{ subdivision.id }}">-</span>
                                    <span class="tree-icon">üè≠</span> {{ subdivision.name }}
                                </div>
                            </td>
                            <td></td>
                            <td></td>
                        </tr>
                        
                        <!-- üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (–±–µ–∑ –æ—Ç–¥–µ–ª–∞) -->
                        {% for employee in subdivision.employees %}
                            <tr class="tree-row" data-level="2" data-parent="sub-{{ subdivision.id }}">
                                <td>
                                    <input type="checkbox" class="custom-checkbox employee-checkbox" 
                                           data-id="{{ employee.id }}" data-type="employee">
                                </td>
                                <td>
                                    <div class="tree-level tree-level-2">
                                        <span class="tree-icon">üë§</span> {{ employee.full_name_nominative }}
                                    </div>
                                </td>
                                <td>{{ employee.position.position_name }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'directory:employees:employee_update' employee.pk %}" 
                                           class="btn btn-outline-primary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'directory:siz:siz_personal_card' employee.id %}" 
                                           class="btn btn-outline-info">
                                            <i class="fas fa-id-card"></i>
                                        </a>
                                        <a href="{% url 'directory:siz:siz_issue_for_employee' employee.id %}" 
                                           class="btn btn-outline-success">
                                            <i class="fas fa-hard-hat"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        
                        <!-- üìÇ –û—Ç–¥–µ–ª—ã -->
                        {% for department in subdivision.departments %}
                            <tr class="tree-row department-row" data-level="2" 
                                data-parent="sub-{{ subdivision.id }}" 
                                data-node-id="dept-{{ department.id }}">
                                <td>
                                    <input type="checkbox" class="custom-checkbox dept-checkbox" 
                                           data-id="dept-{{ department.id }}">
                                </td>
                                <td>
                                    <div class="tree-level tree-level-2">
                                        <span class="tree-toggle" data-node="dept-{{ department.id }}">-</span>
                                        <span class="tree-icon">üìÇ</span> {{ department.name }}
                                    </div>
                                </td>
                                <td></td>
                                <td></td>
                            </tr>
                            
                            <!-- üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ—Ç–¥–µ–ª–∞ -->
                            {% for employee in department.employees %}
                                <tr class="tree-row" data-level="3" data-parent="dept-{{ department.id }}">
                                    <td>
                                        <input type="checkbox" class="custom-checkbox employee-checkbox" 
                                               data-id="{{ employee.id }}" data-type="employee">
                                    </td>
                                    <td>
                                        <div class="tree-level tree-level-3">
                                            <span class="tree-icon">üë§</span> {{ employee.full_name_nominative }}
                                        </div>
                                    </td>
                                    <td>{{ employee.position.position_name }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'directory:employees:employee_update' employee.pk %}" 
                                               class="btn btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'directory:siz:siz_personal_card' employee.id %}" 
                                               class="btn btn-outline-info">
                                                <i class="fas fa-id-card"></i>
                                            </a>
                                            <a href="{% url 'directory:siz:siz_issue_for_employee' employee.id %}" 
                                               class="btn btn-outline-success">
                                                <i class="fas fa-hard-hat"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endfor %} <!-- –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
                    {% endfor %} <!-- –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º -->
                {% endfor %} <!-- –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º -->
            </tbody>
        </table>
    </div>
</div>

<!-- üìù –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–π–º–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
<div class="modal fade" id="hireEmployeeModal" tabindex="-1" aria-labelledby="hireEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hireEmployeeModalLabel">–ü—Ä–∏–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="hireFormContainer">
                    <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Ñ–æ—Ä–º–∞ –Ω–∞–π–º–∞ —á–µ—Ä–µ–∑ AJAX -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üõ°Ô∏è –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–¥–∞—á–∏ –°–ò–ó -->
<div class="modal fade" id="issueSIZModal" tabindex="-1" aria-labelledby="issueSIZModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="issueSIZModalLabel">–í—ã–¥–∞—á–∞ –°–ò–ó</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="sizFormContainer">
                    <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Ñ–æ—Ä–º–∞ –≤—ã–¥–∞—á–∏ –°–ò–ó —á–µ—Ä–µ–∑ AJAX -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // üíæ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const treeTable = document.getElementById('employeeTree');
        const actionsDropdown = document.getElementById('actionsDropdown');
        const selectedCounter = document.getElementById('selectedCounter');
        const counterValue = document.getElementById('counterValue');
        const selectAllCheckbox = document.getElementById('selectAll');
        
        let selectedEmployees = []; // üë• –ú–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        
        // üå≥ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É–∑–ª–∞ –¥–µ—Ä–µ–≤–∞
        function toggleNode(nodeId, expand = true) {
            const toggleElement = document.querySelector(`.tree-toggle[data-node="${nodeId}"]`);
            if (!toggleElement) return;
            
            toggleElement.textContent = expand ? '-' : '+';
            
            const children = treeTable.querySelectorAll(`tr[data-parent="${nodeId}"]`);
            children.forEach(child => {
                if (expand) {
                    child.classList.remove('tree-hidden');
                } else {
                    child.classList.add('tree-hidden');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —Ä–µ–±–µ–Ω–∫–∞ —Å–≤–æ–∏ –¥–µ—Ç–∏
                    const childNodeId = child.dataset.nodeId;
                    if (childNodeId) {
                        toggleNode(childNodeId, false);
                    }
                }
            });
        }
        
        // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        function updateCounter() {
            const count = selectedEmployees.length;
            counterValue.textContent = count;
            
            if (count > 0) {
                selectedCounter.style.display = 'inline-block';
                actionsDropdown.disabled = false;
            } else {
                selectedCounter.style.display = 'none';
                actionsDropdown.disabled = true;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –¥—Ä–æ–ø–¥–∞—É–Ω–µ
            document.getElementById('selectedCount').textContent = count;
        }
        
        // üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        selectAllCheckbox.addEventListener('change', function() {
            const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');
            employeeCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ —É–¥–∞–ª—è–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                const employeeId = checkbox.dataset.id;
                const index = selectedEmployees.indexOf(employeeId);
                
                if (selectAllCheckbox.checked && index === -1) {
                    selectedEmployees.push(employeeId);
                } else if (!selectAllCheckbox.checked && index !== -1) {
                    selectedEmployees.splice(index, 1);
                }
            });
            
            updateCounter();
        });
        
        // üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        treeTable.addEventListener('change', function(e) {
            const checkbox = e.target;
            if (!checkbox.classList.contains('custom-checkbox')) return;
            
            if (checkbox.classList.contains('employee-checkbox')) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                const employeeId = checkbox.dataset.id;
                const index = selectedEmployees.indexOf(employeeId);
                
                if (checkbox.checked && index === -1) {
                    selectedEmployees.push(employeeId);
                } else if (!checkbox.checked && index !== -1) {
                    selectedEmployees.splice(index, 1);
                }
                
                updateCounter();
                
            } else if (checkbox.classList.contains('org-checkbox') || 
                       checkbox.classList.contains('sub-checkbox') || 
                       checkbox.classList.contains('dept-checkbox')) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ/–æ—Ç–¥–µ–ª)
                const nodeId = checkbox.dataset.id;
                const children = treeTable.querySelectorAll(`tr[data-parent="${nodeId}"] .custom-checkbox`);
                
                children.forEach(childCheckbox => {
                    childCheckbox.checked = checkbox.checked;
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                    if (childCheckbox.classList.contains('employee-checkbox')) {
                        const empId = childCheckbox.dataset.id;
                        const index = selectedEmployees.indexOf(empId);
                        
                        if (checkbox.checked && index === -1) {
                            selectedEmployees.push(empId);
                        } else if (!checkbox.checked && index !== -1) {
                            selectedEmployees.splice(index, 1);
                        }
                    }
                });
                
                updateCounter();
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω—ã –ª–∏ –≤—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
            const allEmployeeCheckboxes = document.querySelectorAll('.employee-checkbox');
            const checkedEmployeeCheckboxes = document.querySelectorAll('.employee-checkbox:checked');
            
            selectAllCheckbox.checked = 
                allEmployeeCheckboxes.length > 0 && 
                allEmployeeCheckboxes.length === checkedEmployeeCheckboxes.length;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤—ã–±—Ä–∞–Ω—ã –ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ (indeterminate)
            selectAllCheckbox.indeterminate = 
                checkedEmployeeCheckboxes.length > 0 && 
                checkedEmployeeCheckboxes.length < allEmployeeCheckboxes.length;
        });
        
        // üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∏–∫–æ–Ω–∫–∞–º —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
        treeTable.addEventListener('click', function(e) {
            const toggleElement = e.target.closest('.tree-toggle');
            if (!toggleElement) return;
            
            const nodeId = toggleElement.dataset.node;
            const isExpanded = toggleElement.textContent === '-';
            toggleNode(nodeId, !isExpanded);
        });
        
        // üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ"
        document.getElementById('btnExpandAll').addEventListener('click', function() {
            const nodes = treeTable.querySelectorAll('.tree-toggle');
            nodes.forEach(node => {
                const nodeId = node.dataset.node;
                toggleNode(nodeId, true);
            });
        });
        
        // üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ"
        document.getElementById('btnCollapseAll').addEventListener('click', function() {
            const orgNodes = treeTable.querySelectorAll('.tree-toggle[data-node^="org-"]');
            orgNodes.forEach(node => {
                const nodeId = node.dataset.node;
                toggleNode(nodeId, false);
            });
        });
        
        // üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–Ω—è—Ç—å –Ω–∞ —Ä–∞–±–æ—Ç—É"
        document.getElementById('btnHireEmployee').addEventListener('click', function() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ä–º—É –Ω–∞–π–º–∞ —á–µ—Ä–µ–∑ AJAX
            fetch('{% url "directory:load_employee_hiring_form" %}')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('hireFormContainer').innerHTML = html;
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Select2 –∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (window.initializeFormComponents) {
                        window.initializeFormComponents();
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    const modal = new bootstrap.Modal(document.getElementById('hireEmployeeModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ä–º—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                });
        });
        
        // üõ°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–í—ã–¥–∞—Ç—å –°–ò–ó"
        document.getElementById('btnIssueSIZ').addEventListener('click', function() {
            if (selectedEmployees.length === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –≤—ã–¥–∞—á–∏ –°–ò–ó.');
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            const employeeParams = selectedEmployees.map(id => `employee_id=${id}`).join('&');
            const url = `{% url "directory:load_siz_issue_form" %}?${employeeParams}`;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ä–º—É –≤—ã–¥–∞—á–∏ –°–ò–ó —á–µ—Ä–µ–∑ AJAX
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sizFormContainer').innerHTML = html;
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (window.initializeSIZForm) {
                        window.initializeSIZForm();
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    const modal = new bootstrap.Modal(document.getElementById('issueSIZModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã –≤—ã–¥–∞—á–∏ –°–ò–ó:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ä–º—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                });
        });
        
        // üìã –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ—Ç–∞"
        document.getElementById('btnIssueCard').addEventListener('click', function() {
            if (selectedEmployees.length === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ—Ç–∞.');
                return;
            }
            
            if (selectedEmployees.length > 1) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ—Ç–∞.');
                return;
            }
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const employeeId = selectedEmployees[0];
            window.location.href = `{% url "directory:siz:siz_personal_card" 0 %}`.replace('0', employeeId);
        });
        
        // ‚úèÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
        document.getElementById('btnEditEmployee').addEventListener('click', function() {
            if (selectedEmployees.length === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
                return;
            }
            
            if (selectedEmployees.length > 1) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
                return;
            }
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const employeeId = selectedEmployees[0];
            window.location.href = `{% url "directory:employees:employee_update" 0 %}`.replace('0', employeeId);
        });
        
        // üîç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        const orgNodes = treeTable.querySelectorAll('.tree-toggle[data-node^="sub-"], .tree-toggle[data-node^="dept-"]');
        orgNodes.forEach(node => {
            const nodeId = node.dataset.node;
            toggleNode(nodeId, false);
        });
    });
</script>
{% endblock %}