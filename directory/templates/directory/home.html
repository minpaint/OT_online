{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π CSS —Ñ–∞–π–ª –¥–ª—è —Å—Ç–∏–ª–µ–π –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã -->
<link rel="stylesheet" href="{% static 'directory/css/tree_view.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- üîç –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="search-form">
                <div class="input-group">
                    <input type="text" id="localSearchInput" class="form-control tree-search" placeholder="–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ..." value="">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-primary" id="localSearchBtn">
                            <i class="fas fa-search"></i> –ù–∞–π—Ç–∏
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearSearchBtn">
                            <i class="fas fa-times"></i> –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </div>
                <small class="form-text text-muted">–ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Ç–µ–∫—É—â–∏–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º, –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</small>
            </form>
        </div>
    </div>

    <!-- üéØ –ü–∞–Ω–µ–ª—å —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ -->
    <div class="actions-bar">
        <button id="btnExpandAll" class="btn btn-sm btn-outline-secondary me-2 expand-all">
            <i class="fas fa-expand-alt"></i> –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ
        </button>
        <button id="btnCollapseAll" class="btn btn-sm btn-outline-secondary me-2 collapse-all">
            <i class="fas fa-compress-alt"></i> –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ
        </button>
        <div class="dropdown d-inline-block me-2">
            <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="actionsDropdown" 
                    data-bs-toggle="dropdown" aria-expanded="false" disabled>
                –î–µ–π—Å—Ç–≤–∏—è <span id="selectedCount" class="badge bg-light text-dark ms-1">0</span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="actionsDropdown">
                <li><a class="dropdown-item" href="#" id="btnIssueCard">
                    <i class="fas fa-id-card"></i> –ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ—Ç–∞
                </a></li>
                <li><a class="dropdown-item" href="#" id="btnIssueSIZ">
                    <i class="fas fa-hard-hat"></i> –í—ã–¥–∞—Ç—å –°–ò–ó
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="btnEditEmployee">
                    <i class="fas fa-user-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </a></li>
            </ul>
        </div>
        
        <a href="{% url 'directory:employees:employee_hire' %}" class="btn btn-success btn-sm ms-auto">
            <i class="fas fa-user-plus"></i> –ü—Ä–∏–Ω—è—Ç—å –Ω–∞ —Ä–∞–±–æ—Ç—É
        </a>
        
        <div id="selectedCounter" class="select-count text-muted" style="display: none;">
            –í—ã–±—Ä–∞–Ω–æ: <span id="counterValue">0</span>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è URL (–≤–º–µ—Å—Ç–æ Django-—Ç–µ–≥–æ–≤ –≤–Ω—É—Ç—Ä–∏ JS) -->
    <div hidden>
        <span data-siz-personal-card-url="{% url 'directory:siz:siz_personal_card' 0 %}"></span>
        <span data-siz-issue-url="{% url 'directory:siz:siz_issue_for_employee' 0 %}"></span>
        <span data-employee-update-url="{% url 'directory:employees:employee_update' 0 %}"></span>
    </div>

    <!-- üìã –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
    <div class="table-responsive mt-2">
        <table class="tree-table table table-hover" id="employeeTree">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="custom-checkbox" id="select-all">
                    </th>
                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for organization in organizations %}
                <!-- üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
                <tr class="tree-row organization-row" data-level="0" data-node-id="org-{{ organization.id }}">
                    <td>
                        <input type="checkbox" class="custom-checkbox org-checkbox" 
                               data-id="org-{{ organization.id }}">
                    </td>
                    <td class="field-name">
                        <span class="tree-toggle" data-node="org-{{ organization.id }}">-</span>
                        <span class="tree-icon">üè¢</span> <strong>{{ organization.short_name }}</strong>
                    </td>
                    <td></td>
                </tr>
                
                <!-- üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–±–µ–∑ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è) -->
                {% for employee in organization.employees %}
                <tr class="tree-row" data-level="1" data-parent="org-{{ organization.id }}">
                    <td>
                        <input type="checkbox" class="custom-checkbox employee-checkbox" 
                               data-id="{{ employee.id }}" data-type="employee">
                    </td>
                    <td class="field-name">
                        <div class="tree-level">
                            <span class="tree-icon">üë§</span> {{ employee.full_name_nominative }} - {{ employee.position.position_name }}
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'directory:employees:employee_update' employee.pk %}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'directory:siz:siz_personal_card' employee.id %}" 
                               class="btn btn-outline-info">
                                <i class="fas fa-id-card"></i>
                            </a>
                            <a href="{% url 'directory:siz:siz_issue_for_employee' employee.id %}" 
                               class="btn btn-outline-success">
                                <i class="fas fa-hard-hat"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}

                <!-- üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
                {% for subdivision in organization.subdivisions %}
                <tr class="tree-row subdivision-row" data-level="1" 
                    data-parent="org-{{ organization.id }}" 
                    data-node-id="sub-{{ subdivision.id }}">
                    <td>
                        <input type="checkbox" class="custom-checkbox sub-checkbox" 
                               data-id="sub-{{ subdivision.id }}">
                    </td>
                    <td class="field-name">
                        <div class="tree-level">
                            <span class="tree-toggle" data-node="sub-{{ subdivision.id }}">-</span>
                            <span class="tree-icon">üè≠</span> <strong>{{ subdivision.name }}</strong>
                        </div>
                    </td>
                    <td></td>
                </tr>
                
                <!-- üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (–±–µ–∑ –æ—Ç–¥–µ–ª–∞) -->
                {% for employee in subdivision.employees %}
                <tr class="tree-row" data-level="2" data-parent="sub-{{ subdivision.id }}">
                    <td>
                        <input type="checkbox" class="custom-checkbox employee-checkbox" 
                               data-id="{{ employee.id }}" data-type="employee">
                    </td>
                    <td class="field-name">
                        <div class="tree-level tree-level-2">
                            <span class="tree-icon">üë§</span> {{ employee.full_name_nominative }} - {{ employee.position.position_name }}
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'directory:employees:employee_update' employee.pk %}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'directory:siz:siz_personal_card' employee.id %}" 
                               class="btn btn-outline-info">
                                <i class="fas fa-id-card"></i>
                            </a>
                            <a href="{% url 'directory:siz:siz_issue_for_employee' employee.id %}" 
                               class="btn btn-outline-success">
                                <i class="fas fa-hard-hat"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}

                <!-- üìÇ –û—Ç–¥–µ–ª—ã -->
                {% for department in subdivision.departments %}
                <tr class="tree-row department-row" data-level="2" 
                    data-parent="sub-{{ subdivision.id }}" 
                    data-node-id="dept-{{ department.id }}">
                    <td>
                        <input type="checkbox" class="custom-checkbox dept-checkbox" 
                               data-id="dept-{{ department.id }}">
                    </td>
                    <td class="field-name">
                        <div class="tree-level tree-level-2">
                            <span class="tree-toggle" data-node="dept-{{ department.id }}">-</span>
                            <span class="tree-icon">üìÇ</span> <strong>{{ department.name }}</strong>
                        </div>
                    </td>
                    <td></td>
                </tr>
                
                <!-- üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ—Ç–¥–µ–ª–∞ -->
                {% for employee in department.employees %}
                <tr class="tree-row" data-level="3" data-parent="dept-{{ department.id }}">
                    <td>
                        <input type="checkbox" class="custom-checkbox employee-checkbox" 
                               data-id="{{ employee.id }}" data-type="employee">
                    </td>
                    <td class="field-name">
                        <div class="tree-level tree-level-3">
                            <span class="tree-icon">üë§</span> {{ employee.full_name_nominative }} - {{ employee.position.position_name }}
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'directory:employees:employee_update' employee.pk %}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'directory:siz:siz_personal_card' employee.id %}" 
                               class="btn btn-outline-info">
                                <i class="fas fa-id-card"></i>
                            </a>
                            <a href="{% url 'directory:siz:siz_issue_for_employee' employee.id %}" 
                               class="btn btn-outline-success">
                                <i class="fas fa-hard-hat"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% endfor %} <!-- –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
                {% endfor %} <!-- –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º -->
                {% endfor %} <!-- –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º -->
            </tbody>
        </table>
    </div>
    
    <!-- üìÑ –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if is_paginated %}
    <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º" class="mt-3">
        <ul class="pagination">
            {% if organizations.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="–ü–µ—Ä–≤–∞—è">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ organizations.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&laquo;&laquo;</span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">&laquo;</span>
            </li>
            {% endif %}
            
            {% for num in paginator.page_range %}
                {% if organizations.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > organizations.number|add:'-3' and num < organizations.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if organizations.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ organizations.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="–°–ª–µ–¥—É—é—â–∞—è">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="–ü–æ—Å–ª–µ–¥–Ω—è—è">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">&raquo;&raquo;</span>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JavaScript —Ñ–∞–π–ª—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–µ—Ä–µ–≤–æ–º -->
<script src="{% static 'admin/js/tree_view.js' %}"></script>
<script src="{% static 'admin/js/tree_search.js' %}"></script>
{% endblock %}