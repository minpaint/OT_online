{% extends "admin/change_list.html" %}
{% load i18n admin_urls static directory_tags %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/tree_view.css' %}">
    <script type="text/javascript" src="{% static 'admin/js/tree_view.js' %}"></script>
{% endblock %}

{% block result_list %}
<div class="tree-controls">
    <button type="button" class="tree-btn expand-all">{% trans "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë" %}</button>
    <button type="button" class="tree-btn collapse-all">{% trans "–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë" %}</button>
    <div class="tree-search-container">
        <input type="text" class="tree-search" placeholder="{% trans '–ü–æ–∏—Å–∫ –≤ –¥–µ—Ä–µ–≤–µ...' %}">
    </div>
</div>

<table id="result_list" class="tree-table">
    <thead>
        <tr>
            <th class="column-checkbox">
                <input type="checkbox" id="select-all">
            </th>
            <th class="column-name">{% trans "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" %}</th>
            <th class="column-roles">{% trans "–°–æ—Å—Ç–∞–≤" %}</th>
            <th class="column-actions">{% trans "–î–µ–π—Å—Ç–≤–∏—è" %}</th>
        </tr>
    </thead>
    <tbody>
        {% for org, org_data in tree.items %}
            <!-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
            <tr class="tree-row" data-level="0" data-node-id="org-{{ org.pk }}" data-parent-id="">
                <td class="column-checkbox"></td>
                <td class="field-name">
                    <button class="toggle-btn" data-state="expanded" onclick="event.stopPropagation();">[-]</button>
                    <span class="tree-icon">{{ tree_settings.icons.organization }}</span>
                    {{ org_data.name }}
                </td>
                <td class="field-roles"></td>
                <td class="field-actions"></td>
            </tr>
            
            <!-- –ö–æ–º–∏—Å—Å–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
            {% for item in org_data.items %}
                <tr class="tree-row" data-level="1" data-node-id="item-{{ item.pk }}" data-parent-id="org-{{ org.pk }}">
                    <td class="column-checkbox">
                        <input type="checkbox" name="_selected_action" value="{{ item.pk }}" class="action-select">
                    </td>
                    <td class="field-name">
                        {% with commission_type=item.commission_type %}
                            <span class="tree-icon">{{ tree_settings.icons|get_item:commission_type }}</span>
                            <a href="{% url 'admin:directory_commission_change' item.pk %}">
                                {{ item.name }} {% if not item.is_active %}[–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞]{% endif %}
                            </a>
                        {% endwith %}
                    </td>
                    <td class="field-roles">
                        {% if item.members %}
                            {% for chairman in item.members.chairman %}
                                <div>üëë {{ chairman.name }} - {{ chairman.position }}</div>
                            {% endfor %}
                            {% for secretary in item.members.secretary %}
                                <div>üìù {{ secretary.name }} - {{ secretary.position }}</div>
                            {% endfor %}
                            {% for member in item.members.members %}
                                <div>üë§ {{ member.name }} - {{ member.position }}</div>
                            {% endfor %}
                        {% else %}
                            <em>–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</em>
                        {% endif %}
                    </td>
                    <td class="field-actions">
                        <a href="{% url 'admin:directory_commission_change' item.pk %}" class="button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    </td>
                </tr>
            {% endfor %}
            
            <!-- –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
            {% for sub, sub_data in org_data.subdivisions.items %}
                <tr class="tree-row" data-level="1" data-node-id="sub-{{ sub.pk }}" data-parent-id="org-{{ org.pk }}">
                    <td class="column-checkbox"></td>
                    <td class="field-name">
                        <button class="toggle-btn" data-state="expanded" onclick="event.stopPropagation();">[-]</button>
                        <span class="tree-icon">{{ tree_settings.icons.subdivision }}</span>
                        {{ sub_data.name }}
                    </td>
                    <td class="field-roles"></td>
                    <td class="field-actions"></td>
                </tr>
                
                <!-- –ö–æ–º–∏—Å—Å–∏–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
                {% for item in sub_data.items %}
                    <tr class="tree-row" data-level="2" data-node-id="item-{{ item.pk }}" data-parent-id="sub-{{ sub.pk }}">
                        <td class="column-checkbox">
                            <input type="checkbox" name="_selected_action" value="{{ item.pk }}" class="action-select">
                        </td>
                        <td class="field-name">
                            {% with commission_type=item.commission_type %}
                                <span class="tree-icon">{{ tree_settings.icons|get_item:commission_type }}</span>
                                <a href="{% url 'admin:directory_commission_change' item.pk %}">
                                    {{ item.name }} {% if not item.is_active %}[–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞]{% endif %}
                                </a>
                            {% endwith %}
                        </td>
                        <td class="field-roles">
                            {% if item.members %}
                                {% for chairman in item.members.chairman %}
                                    <div>üëë {{ chairman.name }} - {{ chairman.position }}</div>
                                {% endfor %}
                                {% for secretary in item.members.secretary %}
                                    <div>üìù {{ secretary.name }} - {{ secretary.position }}</div>
                                {% endfor %}
                                {% for member in item.members.members %}
                                    <div>üë§ {{ member.name }} - {{ member.position }}</div>
                                {% endfor %}
                            {% else %}
                                <em>–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</em>
                            {% endif %}
                        </td>
                        <td class="field-actions">
                            <a href="{% url 'admin:directory_commission_change' item.pk %}" class="button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        </td>
                    </tr>
                {% endfor %}
                
                <!-- –û—Ç–¥–µ–ª—ã -->
                {% for dept, dept_data in sub_data.departments.items %}
                    <tr class="tree-row" data-level="2" data-node-id="dept-{{ dept.pk }}" data-parent-id="sub-{{ sub.pk }}">
                        <td class="column-checkbox"></td>
                        <td class="field-name">
                            <button class="toggle-btn" data-state="expanded" onclick="event.stopPropagation();">[-]</button>
                            <span class="tree-icon">{{ tree_settings.icons.department }}</span>
                            {{ dept_data.name }}
                        </td>
                        <td class="field-roles"></td>
                        <td class="field-actions"></td>
                    </tr>
                    
                    <!-- –ö–æ–º–∏—Å—Å–∏–∏ –æ—Ç–¥–µ–ª–∞ -->
                    {% for item in dept_data.items %}
                        <tr class="tree-row" data-level="3" data-node-id="item-{{ item.pk }}" data-parent-id="dept-{{ dept.pk }}">
                            <td class="column-checkbox">
                                <input type="checkbox" name="_selected_action" value="{{ item.pk }}" class="action-select">
                            </td>
                            <td class="field-name">
                                {% with commission_type=item.commission_type %}
                                    <span class="tree-icon">{{ tree_settings.icons|get_item:commission_type }}</span>
                                    <a href="{% url 'admin:directory_commission_change' item.pk %}">
                                        {{ item.name }} {% if not item.is_active %}[–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞]{% endif %}
                                    </a>
                                {% endwith %}
                            </td>
                            <td class="field-roles">
                                {% if item.members %}
                                    {% for chairman in item.members.chairman %}
                                        <div>üëë {{ chairman.name }} - {{ chairman.position }}</div>
                                    {% endfor %}
                                    {% for secretary in item.members.secretary %}
                                        <div>üìù {{ secretary.name }} - {{ secretary.position }}</div>
                                    {% endfor %}
                                    {% for member in item.members.members %}
                                        <div>üë§ {{ member.name }} - {{ member.position }}</div>
                                    {% endfor %}
                                {% else %}
                                    <em>–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</em>
                                {% endif %}
                            </td>
                            <td class="field-actions">
                                <a href="{% url 'admin:directory_commission_change' item.pk %}" class="button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block pagination %}{% endblock %}