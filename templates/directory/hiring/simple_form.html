{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
  /* Общие стили для формы */
  .card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border-radius: 0.5rem;
  }

  .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 0.5rem 0.5rem 0 0 !important;
    padding: 1.5rem;
  }

  .card-header h5 {
    font-weight: 600;
    margin-bottom: 0;
    font-size: 1.25rem;
  }

  .card-body {
    padding: 2rem;
  }

  .form-section {
    margin-bottom: 1.5rem;
  }

  /* Стили для заголовков секций */
  .section-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-title i {
    color: #667eea;
    font-size: 1.1rem;
  }

  /* Улучшенные стили для labels */
  label {
    font-weight: 500;
    color: #4a5568;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  /* Улучшенные стили для input полей */
  .form-control {
    border: 1.5px solid #e2e8f0;
    border-radius: 0.375rem;
    padding: 0.625rem 0.75rem;
    font-size: 0.95rem;
    transition: all 0.2s;
  }

  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .info-box {
    padding: 15px;
    border-radius: 5px;
    margin-top: 15px;
    margin-bottom: 15px;
  }

  .info-box-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
  }

  .info-box-info {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
  }

  .info-box-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
  }

  .info-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 5px;
    margin-bottom: 5px;
  }

  .badge-medical {
    background-color: #d1ecf1;
    color: #0c5460;
  }

  .badge-siz {
    background-color: #d4edda;
    color: #155724;
  }

  /* Улучшенные стили для алертов */
  .alert {
    border-radius: 0.5rem;
    border: none;
    padding: 1rem 1.25rem;
  }

  .alert-info {
    background-color: #e7f3ff;
    color: #0c5460;
  }

  .alert-success {
    background-color: #d4edda;
    color: #155724;
  }

  /* Стили для кнопок только внутри формы */
  #hiring-form .btn {
    border-radius: 0.375rem;
    font-weight: 500;
    padding: 0.625rem 1.25rem;
    transition: all 0.2s;
  }

  #hiring-form .btn-success {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
  }

  #hiring-form .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  #hiring-form .btn-outline-secondary {
    border: 2px solid #cbd5e0;
    color: #4a5568;
  }

  #hiring-form .btn-outline-secondary:hover {
    background-color: #f7fafc;
    border-color: #a0aec0;
  }

  #hiring-form .btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
  }

  /* Убираем индикатор шагов - форма одностраничная */
  .steps-indicator {
    display: none;
  }


  /* --- УЛУЧШЕННЫЕ СТИЛИ ДЛЯ Select2 --- */

  /* Базовые стили контейнера */
  .select2-container .select2-selection--single {
    height: 42px !important;
    border: 1.5px solid #e2e8f0 !important;
    border-radius: 0.375rem !important;
    transition: all 0.2s !important;
  }

  /* ЦЕНТРИРОВАНИЕ ТЕКСТА */
  .select2-selection__rendered {
    line-height: 40px !important;
    padding-left: 12px !important;
    padding-right: 30px !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    font-size: 0.95rem !important;
    color: #2d3748 !important;
  }

  /* ЦЕНТРИРОВАНИЕ ПЛЕЙСХОЛДЕРА */
  .select2-selection__placeholder {
    line-height: 40px !important;
    padding-left: 12px !important;
    padding-right: 30px !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    font-size: 0.95rem !important;
    color: #a0aec0 !important;
  }

  .select2-container .select2-selection--single .select2-selection__arrow {
    height: 38px !important;
    right: 1px !important;
    width: 20px !important;
    top: 0 !important;
  }

  .select2-container .select2-selection--single .select2-selection__arrow b {
    border-color: #999 transparent transparent transparent !important;
    border-style: solid !important;
    border-width: 5px 4px 0 4px !important;
    position: absolute !important;
    top: 50% !important;
    margin-top: -2px !important;
    left: 50% !important;
    margin-left: -4px !important;
  }

  /* Стили для фокуса */
  .select2-container--focus .select2-selection--single,
  .select2-container.select2-container--focus .select2-selection--single {
    border-color: #667eea !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    outline: 0 !important;
  }

  /* Стили для выпадающего списка */
  .select2-dropdown {
    border: 1.5px solid #e2e8f0 !important;
    border-radius: 0.5rem !important;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
    z-index: 9999 !important;
    margin-top: 4px !important;
  }

  .select2-results__option {
    padding: 0.625rem 1rem !important;
    font-size: 0.95rem !important;
    transition: background-color 0.15s !important;
  }

  .select2-results__option--highlighted {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: #fff !important;
  }

  .select2-results__option--selected {
    background-color: #f7fafc !important;
    color: #2d3748 !important;
    font-weight: 500 !important;
  }

  /* Стили для состояния "загрузка" */
  .select2-container--loading .select2-selection--single .select2-selection__rendered::after {
    content: "Загрузка..." !important;
    color: #6c757d !important;
  }

  /* Убираем стандартные стили для скрытых полей */
  .select2-hidden-accessible {
    display: none !important;
  }

  /* Для формы конкретно */
  #hiring-form .select2-container {
    width: 100% !important;
  }

  /* Дополнительные стили для принудительной стилизации */
  .bootstrap5-styled.select2-container .select2-selection--single {
    height: calc(1.5em + 0.75rem + 2px) !important;
    min-height: 38px !important;
    border: 1px solid #ced4da !important;
    border-radius: 0.375rem !important;
    font-size: 1rem !important;
  }

  .bootstrap5-styled.select2-container .select2-selection--single .select2-selection__rendered {
    line-height: 24px !important;
    padding: 6px 30px 6px 12px !important;
    color: #212529 !important;
    margin-top: 0 !important;
    vertical-align: middle !important;
  }

  /* Стили для фокуса с высоким приоритетом */
  .bootstrap5-styled.select2-container--focus .select2-selection--single {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
  }

  /* Метки (labels) в форме будут по умолчанию выровнены по левому краю */
  /* Если где-то нужно специфичное выравнивание, можно добавить отдельные классы */
  #hiring-form .form-group > label {
    /* text-align: left; */ /* Это стандартное поведение Bootstrap, можно не указывать */
  }

  /* Fieldset заголовки (Организационная структура и т.д.) - если они рендерятся как legend */
  #hiring-form fieldset > legend {
    font-size: 1.25rem; /* Размер как у h5 Bootstrap */
    font-weight: 600;
    padding-bottom: .5rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid #e0e0e0;
    width: 100%; /* Чтобы линия была на всю ширину */
  }

</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Заголовок страницы -->
  <div class="mb-4">
    <h2 class="mb-2" style="color: #2d3748; font-weight: 700;">
      <i class="fas fa-user-plus" style="color: #667eea;"></i> {{ title }}
    </h2>
    <p class="text-muted mb-0">Заполните информацию о новом сотруднике для оформления приема на работу</p>
  </div>

  <!-- Основная форма -->
  <div class="card">
    <div class="card-header text-white">
      <h5><i class="fas fa-clipboard-list"></i> Форма приема на работу</h5>
    </div>
    <div class="card-body">
      {% crispy form %}
    </div>
  </div>
</div>

<!-- Модальные окна (остаются без изменений) -->
<div class="modal fade" id="medicalInfoModal" tabindex="-1" role="dialog" aria-labelledby="medicalInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="medicalInfoModalLabel">Информация о медосмотре</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12">
            <h6>Перечень вредных факторов для должности <span id="position-name-medical"></span>:</h6>
            <div id="medical-factors-list"></div>
            <h6 class="mt-3">Требуемая информация:</h6>
            <ul>
              <li>Дата рождения - обязательно для оформления направления на медосмотр</li>
            </ul>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> Работник должен быть направлен на медицинский осмотр до начала работы. Если он уже прошел медосмотр и признан годным, укажите дату медосмотра.
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
        <button type="button" class="btn btn-primary" id="addMedicalInfoBtn">Добавить информацию</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="sizInfoModal" tabindex="-1" role="dialog" aria-labelledby="sizInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sizInfoModalLabel">Информация о СИЗ</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12">
            <h6>Перечень СИЗ для должности <span id="position-name-siz"></span>:</h6>
            <div id="siz-list"></div>
            <h6 class="mt-3">Требуемая информация:</h6>
            <ul>
              <li>Рост - для подбора спецодежды</li>
              <li>Размер одежды - для подбора спецодежды</li>
              <li>Размер обуви - для подбора спецобуви</li>
            </ul>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> После сохранения сотрудника вам будет предложено распечатать карточку учета выдачи СИЗ.
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
        <button type="button" class="btn btn-primary" id="addSizInfoBtn">Добавить информацию</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
  // Клиентская валидация формы перед отправкой
  $('#hiring-form').on('submit', function(e) {
    var errors = [];

    // Проверяем обязательные поля
    if (!$('#id_full_name_nominative').val()) {
      errors.push('Пожалуйста, укажите ФИО сотрудника');
    }

    if (!$('#id_date_of_birth').val()) {
      errors.push('Пожалуйста, укажите дату рождения');
    }

    if (!$('#id_organization').val()) {
      errors.push('Пожалуйста, выберите организацию');
    }

    if (!$('#id_position').val()) {
      errors.push('Пожалуйста, выберите должность');
    }

    // Если есть ошибки, показываем их и предотвращаем отправку
    if (errors.length > 0) {
      e.preventDefault();
      alert('Необходимо заполнить обязательные поля:\n\n' + errors.join('\n'));
      return false;
    }
  });

  // Позволяем DAL самостоятельно инициализировать autocomplete поля
  // Убираем кастомную инициализацию, которая конфликтует с DAL

  // Ждем полной инициализации DAL и только потом применяем стили
  setTimeout(function() {
    console.log('Проверяем инициализацию DAL...');

    // Проверяем, что поля Select2 инициализированы
    var select2Fields = $('.select2-hidden-accessible').length;
    console.log('Найдено Select2 полей:', select2Fields);

    if (select2Fields > 0) {
      console.log('DAL инициализирован успешно');

      // Применяем inline стили напрямую к элементам
      $('.select2-selection__rendered, .select2-selection__placeholder').each(function() {
        $(this).css({
          'line-height': '38px',
          'padding-top': '0px',
          'padding-bottom': '0px',
          'padding-left': '12px',
          'padding-right': '30px',
          'font-size': '16px',
          'height': '38px',
          'display': 'block'
        });
        console.log('Применены inline стили к:', this.className);
      });

      // Исправляем плейсхолдеры
      $('.select2-selection__placeholder').each(function() {
        var $this = $(this);
        if (!$this.text() || $this.text() === '' || $this.text() === '--------') {
          var $select = $this.closest('.select2-container').siblings('select');
          var placeholder = $select.attr('data-placeholder') || 'Выберите...';
          $this.text(placeholder);
          console.log('Исправлен плейсхолдер:', placeholder);
        }
      });

      // Также применяем стили к контейнерам
      $('.select2-selection--single').each(function() {
        $(this).css({
          'height': '38px',
          'border': '1px solid #ced4da',
          'border-radius': '0.375rem'
        });
      });

      console.log('Стилизация завершена');
    } else {
      console.log('DAL не инициализирован, пытаемся еще раз через 1 секунду...');
      setTimeout(arguments.callee, 1000);
    }
  }, 300);

  $('#id_position').on('change', function() {
    var positionId = $(this).val();

    // Плавное скрытие секций
    $('#medical-section').fadeOut(200, function() {
      $(this).addClass('d-none');
    });
    $('#siz-section').fadeOut(200, function() {
      $(this).addClass('d-none');
    });

    if (positionId) {
      $.ajax({
        url: '/directory/hiring/api/position/' + positionId + '/requirements/',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          var positionName = data.position_name;

          if (data.needs_medical) {
            $('#position-name-medical').text(positionName);
            $('#medical-section').removeClass('d-none').hide().fadeIn(400);
            $.getJSON('/directory/api/medical/position/' + positionId + '/norms/', function(medData) {
              $('#medical-factors-list').empty();
              if (medData.factors && medData.factors.length > 0) {
                var factorsHtml = '<ul>';
                $.each(medData.factors, function(index, factor) {
                  factorsHtml += '<li><strong>' + factor.short_name + '</strong> - ' + factor.full_name + '</li>';
                });
                factorsHtml += '</ul>';
                $('#medical-factors-list').html(factorsHtml);
              } else {
                $('#medical-factors-list').html('<p>Нет информации о вредных факторах.</p>');
              }
            });
          }

          if (data.needs_siz) {
            $('#position-name-siz').text(positionName);
            $('#siz-section').removeClass('d-none').hide().fadeIn(400);
            $.getJSON('/directory/api/positions/' + positionId + '/siz-norms/', function(sizData) {
              $('#siz-list').empty();
              if (sizData.base_norms && sizData.base_norms.length > 0) {
                var sizHtml = '<ul>';
                $.each(sizData.base_norms, function(index, norm) {
                  sizHtml += '<li><strong>' + norm.siz_name + '</strong> - ' + norm.classification +
                            ' (Количество: ' + norm.quantity + ' ' + norm.unit + ')</li>';
                });
                sizHtml += '</ul>';
                $('#siz-list').html(sizHtml);
              } else {
                $('#siz-list').html('<p>Нет информации о СИЗ.</p>');
              }
            });
          }
        },
        error: function(xhr, status, error) {
          console.error('Ошибка при получении информации о должности:', error);
        }
      });
    }
  });

  $('#addMedicalInfoBtn').on('click', function() {
    $('#medicalInfoModal').modal('hide');
    $('html, body').animate({
      scrollTop: $('#medical-section').offset().top - 100
    }, 500);
  });

  $('#addSizInfoBtn').on('click', function() {
    $('#sizInfoModal').modal('hide');
    $('html, body').animate({
      scrollTop: $('#siz-section').offset().top - 100
    }, 500);
  });

  $(document).on('click', '.show-medical-info', function(e) {
    e.preventDefault();
    if ($('#id_position').val()) {
        $('#medicalInfoModal').modal('show');
    } else {
        alert('Пожалуйста, сначала выберите должность.');
    }
  });

  $(document).on('click', '.show-siz-info', function(e) {
    e.preventDefault();
     if ($('#id_position').val()) {
        $('#sizInfoModal').modal('show');
    } else {
        alert('Пожалуйста, сначала выберите должность.');
    }
  });

  if ($('#id_position').val()) {
    $('#id_position').trigger('change');
  }
});
</script>
{% endblock %}