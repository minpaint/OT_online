<!-- templates/directory/hiring/wizard_form.html -->
{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .wizard-steps {
        display: flex;
        margin-bottom: 30px;
        align-items: center;
        justify-content: center;
    }
    
    .wizard-step {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #e9e9e9;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 20px;
        position: relative;
        z-index: 1;
    }
    
    .wizard-step-active {
        background-color: #007bff;
        color: #fff;
    }
    
    .wizard-step-completed {
        background-color: #28a745;
        color: #fff;
    }
    
    .wizard-step::before {
        content: '';
        position: absolute;
        height: 3px;
        width: 50px;
        background-color: #e9e9e9;
        right: 30px;
        z-index: -1;
    }
    
    .wizard-step:first-child::before {
        display: none;
    }
    
    .wizard-step-completed::before,
    .wizard-step-active::before {
        background-color: #28a745;
    }
    
    .wizard-step-label {
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 14px;
    }
    
    .wizard-nav-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mt-4 mb-4">{{ title }}</h1>
    
    <!-- –®–∞–≥–∏ –≤–∏–∑–∞—Ä–¥–∞ -->
    <div class="wizard-steps">
        {% with wizard_steps=wizard.steps %}
            {% for step in wizard.steps.all %}
                <div class="wizard-step {% if step == wizard.steps.current %}wizard-step-active{% elif wizard.steps.prev and wizard.steps.prev >= forloop.counter0 %}wizard-step-completed{% endif %}">
                    {{ forloop.counter }}
                    <span class="wizard-step-label">
                        {% if step == 'basic_info' %}
                            –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        {% elif step == 'medical_info' %}
                            –ú–µ–¥–æ—Å–º–æ—Ç—Ä
                        {% elif step == 'siz_info' %}
                            –°–ò–ó
                        {% endif %}
                    </span>
                </div>
            {% endfor %}
        {% endwith %}
    </div>
    
    <!-- –§–æ—Ä–º–∞ —à–∞–≥–∞ -->
    <div class="card">
        <div class="card-header">
            {% if wizard.steps.current == 'basic_info' %}
                <h4>üìù –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ</h4>
            {% elif wizard.steps.current == 'medical_info' %}
                <h4>üè• –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞</h4>
            {% elif wizard.steps.current == 'siz_info' %}
                <h4>üõ°Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –°–ò–ó</h4>
            {% endif %}
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {{ wizard.management_form }}
                
                {% if wizard.form.errors %}
                <div class="alert alert-danger">
                    <h4 class="alert-heading">–û—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ</h4>
                    {{ wizard.form.errors }}
                </div>
                {% endif %}
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —à–∞–≥–∞ –°–ò–ó -->
                {% if wizard.steps.current == 'siz_info' and siz_norms %}
                <div class="alert alert-info mb-4">
                    <h5>üìã –ü–µ—Ä–µ—á–µ–Ω—å –°–ò–ó –¥–ª—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏:</h5>
                    <ul>
                        {% for norm in siz_norms %}
                        <li>{{ norm.siz.name }} ({{ norm.siz.classification }}) - {{ norm.quantity }} {{ norm.siz.unit }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- –í—ã–≤–æ–¥ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã —Å crispy -->
                {% crispy wizard.form %}
                
                <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
                <div class="wizard-nav-buttons">
                    {% if wizard.steps.prev %}
                    <button name="wizard_goto_step" type="submit" value="{{ wizard.steps.prev }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                    </button>
                    {% else %}
                    <a href="{% url 'directory:hiring:hiring_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </a>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-primary">
                        {% if wizard.steps.next %}
                        –î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>
                        {% else %}
                        <i class="fas fa-check"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –Ω–∞ –ø–µ—Ä–≤–æ–º —à–∞–≥–µ
    document.addEventListener('DOMContentLoaded', function() {
        const step = '{{ wizard.steps.current }}';
        if (step === 'basic_info') {
            const positionSelect = document.getElementById('id_basic_info-position');
            if (positionSelect) {
                positionSelect.addEventListener('change', function() {
                    // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏—è select2
                    setTimeout(function() {
                        // –ó–∞–ø—Ä–æ—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ AJAX
                        const positionId = positionSelect.value;
                        if (positionId) {
                            fetch(`/directory/api/position/${positionId}/needs_step_info/`)
                                .then(response => response.json())
                                .then(data => {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–µ–±—É–µ–º—ã—Ö —à–∞–≥–∞—Ö
                                    if (data.needs_medical || data.needs_siz) {
                                        let message = '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ ';
                                        if (data.needs_medical) message += '—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞. ';
                                        if (data.needs_siz) message += '—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –°–ò–ó. ';
                                        
                                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                        const infoDiv = document.createElement('div');
                                        infoDiv.className = 'alert alert-info mt-2';
                                        infoDiv.innerHTML = message;
                                        
                                        // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
                                        const parentDiv = positionSelect.closest('.form-group');
                                        if (parentDiv) {
                                            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
                                            const prevInfo = parentDiv.querySelector('.alert');
                                            if (prevInfo) prevInfo.remove();
                                            
                                            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                            parentDiv.appendChild(infoDiv);
                                        }
                                    }
                                })
                                .catch(error => console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏:', error));
                        }
                    }, 300);
                });
            }
        }
    });
</script>
{% endblock %}