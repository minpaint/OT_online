{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
<div class="tree-controls">
    <button type="button" class="tree-btn expand-all">↓ Развернуть все</button>
    <button type="button" class="tree-btn collapse-all">↑ Свернуть все</button>
    <div class="tree-search-container">
        <input type="text" class="tree-search" placeholder="🔍 Поиск по дереву...">
    </div>
</div>

<div class="results">
    <table id="result_list">
        <thead>
            <tr>
                <th class="column-name">НАИМЕНОВАНИЕ</th>
                <th class="column-roles">РОЛИ И АТРИБУТЫ</th>
                <th class="column-actions">ДЕЙСТВИЯ</th>
            </tr>
        </thead>
        <tbody>
            {% for org, org_data in tree.items %}
                {# 🏢 Организация #}
                <tr class="tree-row" data-level="0" data-node-id="org_{{ org.id }}">
                    <td class="field-name">
                        <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                        <span class="tree-icon">{{ tree_settings.icons.organization }}</span>
                        <strong>{{ org_data.name }}</strong>
                    </td>
                    <td class="field-roles"></td>
                    <td class="field-actions"></td>
                </tr>

                {# 📄 Элементы организации #}
                {% for item in org_data.items %}
                    <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}">
                        <td class="field-name">
                            <span class="tree-icon">{{ tree_settings.icons.position }}</span>
                            <a href="{% url 'admin:directory_position_change' item.object.pk %}">
                                {{ item.name }}
                            </a>
                        </td>
                        <td class="field-roles">
                            {% if item.object.is_responsible_for_safety %}
                                <span class="role-icon" title="Ответственный за ОТ">🛡️</span>
                            {% endif %}
                            {% if item.object.can_be_internship_leader %}
                                <span class="role-icon" title="Руководитель стажировки">👨‍🏫</span>
                            {% endif %}
                            {% if item.object.is_electrical_personnel %}
                                <span class="role-icon" title="Электротехнический персонал">⚡</span>
                            {% endif %}
                            {% if item.object.commission_role != 'none' %}
                                <span class="role-icon" title="{{ item.object.get_commission_role_display }}">
                                    {% if item.object.commission_role == 'chairman' %}👑
                                    {% elif item.object.commission_role == 'secretary' %}📝
                                    {% else %}👤{% endif %}
                                </span>
                            {% endif %}
                            {% if item.object.documents.exists %}
                                <span class="role-icon" title="Документы">📄 {{ item.object.documents.count }}</span>
                            {% endif %}
                            {% if item.object.equipment.exists %}
                                <span class="role-icon" title="Оборудование">⚙️ {{ item.object.equipment.count }}</span>
                            {% endif %}
                        </td>
                        <td class="field-actions">
                            <a href="{% url 'admin:directory_position_change' item.object.pk %}" class="edit-link" title="Изменить">✏️</a>
                            <a href="{% url 'admin:directory_position_delete' item.object.pk %}" class="delete-link" title="Удалить">🗑️</a>
                            <a href="{% url 'admin:directory_position_history' item.object.pk %}" class="history-link" title="История">📋</a>
                        </td>
                    </tr>
                {% endfor %}

                {# 🏭 Подразделения #}
                {% for sub, sub_data in org_data.subdivisions.items %}
                    <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}" data-node-id="sub_{{ sub.id }}">
                        <td class="field-name">
                            <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                            <span class="tree-icon">{{ tree_settings.icons.subdivision }}</span>
                            {{ sub_data.name }}
                        </td>
                        <td class="field-roles"></td>
                        <td class="field-actions"></td>
                    </tr>

                    {# 📄 Элементы подразделения #}
                    {% for item in sub_data.items %}
                        <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}">
                            <td class="field-name">
                                <span class="tree-icon">{{ tree_settings.icons.position }}</span>
                                <a href="{% url 'admin:directory_position_change' item.object.pk %}">
                                    {{ item.name }}
                                </a>
                            </td>
                            <td class="field-roles">
                                {% if item.object.is_responsible_for_safety %}
                                    <span class="role-icon" title="Ответственный за ОТ">🛡️</span>
                                {% endif %}
                                {% if item.object.can_be_internship_leader %}
                                    <span class="role-icon" title="Руководитель стажировки">👨‍🏫</span>
                                {% endif %}
                                {% if item.object.is_electrical_personnel %}
                                    <span class="role-icon" title="Электротехнический персонал">⚡</span>
                                {% endif %}
                                {% if item.object.commission_role != 'none' %}
                                    <span class="role-icon" title="{{ item.object.get_commission_role_display }}">
                                        {% if item.object.commission_role == 'chairman' %}👑
                                        {% elif item.object.commission_role == 'secretary' %}📝
                                        {% else %}👤{% endif %}
                                    </span>
                                {% endif %}
                                {% if item.object.documents.exists %}
                                    <span class="role-icon" title="Документы">📄 {{ item.object.documents.count }}</span>
                                {% endif %}
                                {% if item.object.equipment.exists %}
                                    <span class="role-icon" title="Оборудование">⚙️ {{ item.object.equipment.count }}</span>
                                {% endif %}
                            </td>
                            <td class="field-actions">
                                <a href="{% url 'admin:directory_position_change' item.object.pk %}" class="edit-link" title="Изменить">✏️</a>
                                <a href="{% url 'admin:directory_position_delete' item.object.pk %}" class="delete-link" title="Удалить">🗑️</a>
                                <a href="{% url 'admin:directory_position_history' item.object.pk %}" class="history-link" title="История">📋</a>
                            </td>
                        </tr>
                    {% endfor %}

                    {# 📂 Отделы #}
                    {% for dept, dept_data in sub_data.departments.items %}
                        <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}" data-node-id="dept_{{ dept.id }}">
                            <td class="field-name">
                                <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                                <span class="tree-icon">{{ tree_settings.icons.department }}</span>
                                {{ dept_data.name }}
                            </td>
                            <td class="field-roles"></td>
                            <td class="field-actions"></td>
                        </tr>

                        {# 📄 Элементы отдела #}
                        {% for item in dept_data.items %}
                            <tr class="tree-row" data-level="3" data-parent-id="dept_{{ dept.id }}">
                                <td class="field-name">
                                    <span class="tree-icon">{{ tree_settings.icons.position }}</span>
                                    <a href="{% url 'admin:directory_position_change' item.object.pk %}">
                                        {{ item.name }}
                                    </a>
                                </td>
                                <td class="field-roles">
                                    {% if item.object.is_responsible_for_safety %}
                                        <span class="role-icon" title="Ответственный за ОТ">🛡️</span>
                                    {% endif %}
                                    {% if item.object.can_be_internship_leader %}
                                        <span class="role-icon" title="Руководитель стажировки">👨‍🏫</span>
                                    {% endif %}
                                    {% if item.object.is_electrical_personnel %}
                                        <span class="role-icon" title="Электротехнический персонал">⚡</span>
                                    {% endif %}
                                    {% if item.object.commission_role != 'none' %}
                                        <span class="role-icon" title="{{ item.object.get_commission_role_display }}">
                                            {% if item.object.commission_role == 'chairman' %}👑
                                            {% elif item.object.commission_role == 'secretary' %}📝
                                            {% else %}👤{% endif %}
                                        </span>
                                    {% endif %}
                                    {% if item.object.documents.exists %}
                                        <span class="role-icon" title="Документы">📄 {{ item.object.documents.count }}</span>
                                    {% endif %}
                                    {% if item.object.equipment.exists %}
                                        <span class="role-icon" title="Оборудование">⚙️ {{ item.object.equipment.count }}</span>
                                    {% endif %}
                                </td>
                                <td class="field-actions">
                                    <a href="{% url 'admin:directory_position_change' item.object.pk %}" class="edit-link" title="Изменить">✏️</a>
                                    <a href="{% url 'admin:directory_position_delete' item.object.pk %}" class="delete-link" title="Удалить">🗑️</a>
                                    <a href="{% url 'admin:directory_position_history' item.object.pk %}" class="history-link" title="История">📋</a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/tree_view.css' %}">
<script src="{% static 'admin/js/tree_view.js' %}"></script>
<script src="{% static 'admin/js/tree_search.js' %}"></script>
{% endblock %}