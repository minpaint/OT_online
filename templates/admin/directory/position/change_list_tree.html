{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
<div class="tree-controls">
    <button type="button" class="tree-btn expand-all">â†“ Ğ Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ²ÑĞµ</button>
    <button type="button" class="tree-btn collapse-all">â†‘ Ğ¡Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ²ÑĞµ</button>
    <div class="tree-search-container">
        <input type="text" class="tree-search" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ´ĞµÑ€ĞµĞ²Ñƒ...">
    </div>
</div>

<div class="results">
    <table id="result_list">
        <thead>
            <tr>
                <th class="column-name">ĞĞĞ˜ĞœĞ•ĞĞĞ’ĞĞĞ˜Ğ•</th>
                <th class="column-roles">Ğ ĞĞ›Ğ˜ Ğ˜ ĞĞ¢Ğ Ğ˜Ğ‘Ğ£Ğ¢Ğ«</th>
                <th class="column-actions">Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ¯</th>
            </tr>
        </thead>
        <tbody>
            {% for org, org_data in tree.items %}
                {# ğŸ¢ ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ #}
                <tr class="tree-row" data-level="0" data-node-id="org_{{ org.id }}">
                    <td class="field-name">
                        <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                        <span class="tree-icon">{{ tree_settings.icons.organization }}</span>
                        <strong>{{ org_data.name }}</strong>
                    </td>
                    <td class="field-roles"></td>
                    <td class="field-actions"></td>
                </tr>

                {# ğŸ“„ Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ #}
                {% for item in org_data.items %}
                    <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}">
                        <td class="field-name">
                            <span class="tree-icon">{{ tree_settings.icons.position }}</span>
                            <a href="{% url 'admin:directory_position_change' item.object.pk %}">
                                {{ item.name }}
                            </a>
                        </td>
                        <td class="field-roles">
                            {% if item.object.is_responsible_for_safety %}
                                <span class="role-icon" title="ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ·Ğ° ĞĞ¢">ğŸ›¡ï¸</span>
                            {% endif %}
                            {% if item.object.can_be_internship_leader %}
                                <span class="role-icon" title="Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ ÑÑ‚Ğ°Ğ¶Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸">ğŸ‘¨â€ğŸ«</span>
                            {% endif %}
                            {% if item.object.is_electrical_personnel %}
                                <span class="role-icon" title="Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»">âš¡</span>
                            {% endif %}
                            {% if item.object.commission_role != 'none' %}
                                <span class="role-icon" title="{{ item.object.get_commission_role_display }}">
                                    {% if item.object.commission_role == 'chairman' %}ğŸ‘‘
                                    {% elif item.object.commission_role == 'secretary' %}ğŸ“
                                    {% else %}ğŸ‘¤{% endif %}
                                </span>
                            {% endif %}
                            {% if item.object.documents.exists %}
                                <span class="role-icon" title="Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹">ğŸ“„ {{ item.object.documents.count }}</span>
                            {% endif %}
                            {% if item.object.equipment.exists %}
                                <span class="role-icon" title="ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ">âš™ï¸ {{ item.object.equipment.count }}</span>
                            {% endif %}
                        </td>
                        <td class="field-actions">
                            <a href="{% url 'admin:directory_position_change' item.object.pk %}" class="edit-link" title="Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ">âœï¸</a>
                            <a href="{% url 'admin:directory_position_delete' item.object.pk %}" class="delete-link" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">ğŸ—‘ï¸</a>
                            <a href="{% url 'admin:directory_position_history' item.object.pk %}" class="history-link" title="Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ">ğŸ“‹</a>
                        </td>
                    </tr>
                {% endfor %}

                {# ğŸ­ ĞŸĞ¾Ğ´Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ #}
                {% for sub, sub_data in org_data.subdivisions.items %}
                    <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}" data-node-id="sub_{{ sub.id }}">
                        <td class="field-name">
                            <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                            <span class="tree-icon">{{ tree_settings.icons.subdivision }}</span>
                            {{ sub_data.name }}
                        </td>
                        <td class="field-roles"></td>
                        <td class="field-actions"></td>
                    </tr>

                    {# ğŸ“„ Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¿Ğ¾Ğ´Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ #}
                    {% for item in sub_data.items %}
                        <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}">
                            <td class="field-name">
                                <span class="tree-icon">{{ tree_settings.icons.position }}</span>
                                <a href="{% url 'admin:directory_position_change' item.object.pk %}">
                                    {{ item.name }}
                                </a>
                            </td>
                            <td class="field-roles">
                                {% if item.object.is_responsible_for_safety %}
                                    <span class="role-icon" title="ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ·Ğ° ĞĞ¢">ğŸ›¡ï¸</span>
                                {% endif %}
                                {% if item.object.can_be_internship_leader %}
                                    <span class="role-icon" title="Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ ÑÑ‚Ğ°Ğ¶Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸">ğŸ‘¨â€ğŸ«</span>
                                {% endif %}
                                {% if item.object.is_electrical_personnel %}
                                    <span class="role-icon" title="Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»">âš¡</span>
                                {% endif %}
                                {% if item.object.commission_role != 'none' %}
                                    <span class="role-icon" title="{{ item.object.get_commission_role_display }}">
                                        {% if item.object.commission_role == 'chairman' %}ğŸ‘‘
                                        {% elif item.object.commission_role == 'secretary' %}ğŸ“
                                        {% else %}ğŸ‘¤{% endif %}
                                    </span>
                                {% endif %}
                                {% if item.object.documents.exists %}
                                    <span class="role-icon" title="Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹">ğŸ“„ {{ item.object.documents.count }}</span>
                                {% endif %}
                                {% if item.object.equipment.exists %}
                                    <span class="role-icon" title="ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ">âš™ï¸ {{ item.object.equipment.count }}</span>
                                {% endif %}
                            </td>
                            <td class="field-actions">
                                <a href="{% url 'admin:directory_position_change' item.object.pk %}" class="edit-link" title="Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ">âœï¸</a>
                                <a href="{% url 'admin:directory_position_delete' item.object.pk %}" class="delete-link" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">ğŸ—‘ï¸</a>
                                <a href="{% url 'admin:directory_position_history' item.object.pk %}" class="history-link" title="Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ">ğŸ“‹</a>
                            </td>
                        </tr>
                    {% endfor %}

                    {# ğŸ“‚ ĞÑ‚Ğ´ĞµĞ»Ñ‹ #}
                    {% for dept, dept_data in sub_data.departments.items %}
                        <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}" data-node-id="dept_{{ dept.id }}">
                            <td class="field-name">
                                <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                                <span class="tree-icon">{{ tree_settings.icons.department }}</span>
                                {{ dept_data.name }}
                            </td>
                            <td class="field-roles"></td>
                            <td class="field-actions"></td>
                        </tr>

                        {# ğŸ“„ Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¾Ñ‚Ğ´ĞµĞ»Ğ° #}
                        {% for item in dept_data.items %}
                            <tr class="tree-row" data-level="3" data-parent-id="dept_{{ dept.id }}">
                                <td class="field-name">
                                    <span class="tree-icon">{{ tree_settings.icons.position }}</span>
                                    <a href="{% url 'admin:directory_position_change' item.object.pk %}">
                                        {{ item.name }}
                                    </a>
                                </td>
                                <td class="field-roles">
                                    {% if item.object.is_responsible_for_safety %}
                                        <span class="role-icon" title="ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ·Ğ° ĞĞ¢">ğŸ›¡ï¸</span>
                                    {% endif %}
                                    {% if item.object.can_be_internship_leader %}
                                        <span class="role-icon" title="Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ ÑÑ‚Ğ°Ğ¶Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸">ğŸ‘¨â€ğŸ«</span>
                                    {% endif %}
                                    {% if item.object.is_electrical_personnel %}
                                        <span class="role-icon" title="Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»">âš¡</span>
                                    {% endif %}
                                    {% if item.object.commission_role != 'none' %}
                                        <span class="role-icon" title="{{ item.object.get_commission_role_display }}">
                                            {% if item.object.commission_role == 'chairman' %}ğŸ‘‘
                                            {% elif item.object.commission_role == 'secretary' %}ğŸ“
                                            {% else %}ğŸ‘¤{% endif %}
                                        </span>
                                    {% endif %}
                                    {% if item.object.documents.exists %}
                                        <span class="role-icon" title="Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹">ğŸ“„ {{ item.object.documents.count }}</span>
                                    {% endif %}
                                    {% if item.object.equipment.exists %}
                                        <span class="role-icon" title="ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ">âš™ï¸ {{ item.object.equipment.count }}</span>
                                    {% endif %}
                                </td>
                                <td class="field-actions">
                                    <a href="{% url 'admin:directory_position_change' item.object.pk %}" class="edit-link" title="Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ">âœï¸</a>
                                    <a href="{% url 'admin:directory_position_delete' item.object.pk %}" class="delete-link" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">ğŸ—‘ï¸</a>
                                    <a href="{% url 'admin:directory_position_history' item.object.pk %}" class="history-link" title="Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ">ğŸ“‹</a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/tree_view.css' %}">
<script src="{% static 'admin/js/tree_view.js' %}"></script>
<script src="{% static 'admin/js/tree_search.js' %}"></script>
{% endblock %}