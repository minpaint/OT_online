{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extrahead %}
{{ block.super }}
{{ formset.media }}
<style>
    .formset-row {
        background-color: #f9f9f9;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 3px solid #417690;
        border-radius: 4px;
    }
    .formset-row:hover {
        background-color: #f0f0f0;
    }
    .delete-row {
        color: #ba2121;
        cursor: pointer;
        font-weight: bold;
    }
    .add-row {
        background-color: #417690;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }
    .add-row:hover {
        background-color: #2d5468;
    }
    .form-row {
        margin-bottom: 15px;
    }
    .form-row label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .help {
        background-color: #e7f3ff;
        padding: 15px;
        border-left: 4px solid #2196F3;
        margin: 20px 0;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">–ì–ª–∞–≤–Ω–∞—è</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='directory' %}">Directory</a>
    &rsaquo; <a href="{% url 'admin:directory_medicalexaminationnorm_changelist' %}">–ù–æ—Ä–º—ã –º–µ–¥–æ—Å–º–æ—Ç—Ä–æ–≤</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div class="module">
    <h1>üìã {{ title }}</h1>

    <div class="help">
        <h3>‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
        <ol>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é (–¥–æ–ª–∂–Ω–æ—Å—Ç—å) –∏–∑ —Å–ø–∏—Å–∫–∞</li>
            <li>–î–æ–±–∞–≤—å—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–¥–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤</li>
            <li>–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–∞</li>
            <li>–ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ—Ä–º</li>
        </ol>
    </div>

    <form method="post">
        {% csrf_token %}

        <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ -->
        <fieldset class="module aligned">
            <h2>1. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é (–¥–æ–ª–∂–Ω–æ—Å—Ç—å)</h2>
            <div class="form-row">
                {{ position_form.position_name.errors }}
                <div>
                    <label for="{{ position_form.position_name.id_for_label }}" class="required">
                        {{ position_form.position_name.label }}:
                    </label>
                    {{ position_form.position_name }}
                    {% if position_form.position_name.help_text %}
                    <p class="help">{{ position_form.position_name.help_text }}</p>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Formset —Å –≤—Ä–µ–¥–Ω—ã–º–∏ —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏ -->
        <fieldset class="module aligned">
            <h2>2. –î–æ–±–∞–≤—å—Ç–µ –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã</h2>

            {{ formset.management_form }}
            {{ formset.non_form_errors }}

            <div id="formset-container">
                {% for form in formset %}
                <div class="formset-row" data-form-index="{{ forloop.counter0 }}">
                    <h3 style="margin-top: 0;">–í—Ä–µ–¥–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä #{{ forloop.counter }}</h3>

                    {{ form.non_field_errors }}

                    <div class="form-row">
                        {{ form.harmful_factor.errors }}
                        <label for="{{ form.harmful_factor.id_for_label }}" class="required">
                            {{ form.harmful_factor.label }}:
                        </label>
                        {{ form.harmful_factor }}
                    </div>

                    <div class="form-row">
                        {{ form.periodicity_override.errors }}
                        <label for="{{ form.periodicity_override.id_for_label }}">
                            {{ form.periodicity_override.label }}:
                        </label>
                        {{ form.periodicity_override }}
                        <p class="help">{{ form.periodicity_override.widget.attrs.placeholder }}</p>
                    </div>

                    <div class="form-row">
                        {{ form.notes.errors }}
                        <label for="{{ form.notes.id_for_label }}">
                            {{ form.notes.label }}:
                        </label>
                        {{ form.notes }}
                    </div>

                    {% if formset.can_delete %}
                    <div class="form-row">
                        {{ form.DELETE }}
                        <label for="{{ form.DELETE.id_for_label }}" class="delete-row">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–∫—Ç–æ—Ä
                        </label>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <button type="button" class="add-row" onclick="addForm()">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë –æ–¥–∏–Ω –≤—Ä–µ–¥–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä
            </button>
        </fieldset>

        <div class="submit-row">
            <input type="submit" value="üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å" class="default">
            <a href="{% url 'admin:directory_medicalexaminationnorm_changelist' %}" class="button cancel-link">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ñ–æ—Ä–º—ã –≤ formset
    function addForm() {
        const container = document.getElementById('formset-container');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const currentFormCount = parseInt(totalForms.value);

        // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ñ–æ—Ä–º—É –∫–∞–∫ —à–∞–±–ª–æ–Ω
        const lastForm = container.querySelector('.formset-row:last-child');
        const newForm = lastForm.cloneNode(true);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –≤ –Ω–æ–≤–æ–π —Ñ–æ—Ä–º–µ
        const formRegex = new RegExp('form-' + (currentFormCount - 1), 'g');
        newForm.innerHTML = newForm.innerHTML.replace(formRegex, 'form-' + currentFormCount);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        newForm.querySelector('h3').textContent = '–í—Ä–µ–¥–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä #' + (currentFormCount + 1);

        // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
        newForm.querySelectorAll('input, select, textarea').forEach(field => {
            if (field.type === 'checkbox') {
                field.checked = false;
            } else {
                field.value = '';
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container.appendChild(newForm);

        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —Ñ–æ—Ä–º
        totalForms.value = currentFormCount + 1;
    }
</script>
{% endblock %}
