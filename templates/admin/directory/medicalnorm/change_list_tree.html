{% extends "admin/change_list.html" %}
{% load static i18n %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/tree_view.css' %}">
  <script src="{% static 'admin/js/tree_view.js' %}"></script>
  <style>
    .profession-icon {
      margin-right: 8px;
      display: inline-block;
    }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ä–µ–≤–∞ */
    .tree-table tr.hidden-by-search {
      display: none;
    }

    .tree-search-container {
      margin: 10px 0;
      position: relative;
    }

    .tree-search {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .tree-search-clear {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #999;
      font-size: 16px;
    }
  </style>
  <script>
    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–∏–∞–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞–∫–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.querySelector('.tree-search');

      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase().trim();
          const rows = document.querySelectorAll('.tree-row[data-level="0"]');

          rows.forEach(row => {
            const searchText = row.getAttribute('data-search-text') || '';
            const isMatch = searchTerm === '' || searchText.includes(searchTerm);

            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            const nodeId = row.getAttribute('data-node-id');
            const childRows = document.querySelectorAll(`.tree-row[data-parent-id="${nodeId}"]`);

            if (isMatch) {
              row.classList.remove('hidden-by-search');
              childRows.forEach(child => child.classList.remove('hidden-by-search'));
            } else {
              row.classList.add('hidden-by-search');
              childRows.forEach(child => child.classList.add('hidden-by-search'));
            }
          });
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –ø–æ–∏—Å–∫–∞
        const clearButton = document.createElement('span');
        clearButton.innerHTML = '‚úï';
        clearButton.className = 'tree-search-clear';
        clearButton.style.display = 'none';

        searchInput.parentNode.appendChild(clearButton);

        searchInput.addEventListener('input', function() {
          clearButton.style.display = this.value ? 'block' : 'none';
        });

        clearButton.addEventListener('click', function() {
          searchInput.value = '';
          searchInput.dispatchEvent(new Event('input'));
          this.style.display = 'none';
        });
      }
    });
  </script>
{% endblock %}

{% block content %}
<div id="content-main">
  <form id="changelist-form" method="post" novalidate>
    {% csrf_token %}

    <div class="object-tools">
      <!-- –ë–æ–ª—å—à–æ–π –∑–µ–ª—ë–Ω—ã–π ¬´+¬ª –≤ —à–∞–ø–∫–µ -->
      <a href="{% url 'admin:directory_medicalexaminationnorm_add' %}" class="addlink">
        –î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ä–º—É –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞
      </a>
    </div>

    <div class="tree-controls">
      <button type="button" class="tree-btn expand-all">‚Üì –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
      <button type="button" class="tree-btn collapse-all">‚Üë –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
      <div class="tree-search-container">
        <input type="text" class="tree-search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º‚Ä¶">
      </div>
    </div>

    <div class="results">
      <table id="result_list" class="tree-table">
        <thead>
          <tr>
            <th>–ü—Ä–æ—Ñ–µ—Å—Å–∏—è (–¥–æ–ª–∂–Ω–æ—Å—Ç—å)</th>
            <th>–ù–æ—Ä–º</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
        {% for prof in professions %}
          {# –°—Ç—Ä–æ–∫–∞ —Å –∏–º–µ–Ω–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ #}
          <tr class="tree-row" data-level="0" data-node-id="prof_{{ forloop.counter }}" data-search-text="{{ prof.name|lower }}">
            <td>
              <span class="tree-toggle"></span>
              <span class="profession-icon">{{ prof.icon|default:"üëî" }}</span>
              <strong>{{ prof.name }}</strong>
            </td>
            <td>{{ prof.norms|length }}</td>
            <td>
              {% if prof.reference_position %}
                <a href="{% url 'admin:directory_medicalexaminationnorm_add' %}?position={{ prof.reference_position.id }}" class="add-link" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ä–º—É –¥–ª—è {{ prof.name }}">+</a>
              {% else %}
                <a href="{% url 'admin:directory_medicalexaminationnorm_add' %}?position_name={{ prof.name|urlencode }}" class="add-link" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ä–º—É –¥–ª—è {{ prof.name }}">+</a>
              {% endif %}
            </td>
          </tr>
          {# –í–ª–æ–∂–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –Ω–æ—Ä–º–∞–º–∏ #}
          <tr class="tree-row" data-level="1" data-parent-id="prof_{{ forloop.counter }}">
            <td colspan="3" style="padding:0">
              <table class="table table-bordered table-striped" style="width:100%">
                <thead>
                  <tr>
                    <th>–§–∞–∫—Ç–æ—Ä</th>
                    <th>–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å (–º–µ—Å.)</th>
                    <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody>
                  {% for norm in prof.norms %}
                    <tr>
                      <td>{{ norm.harmful_factor.short_name }}</td>
                      <td>{{ norm.periodicity }}</td>
                      <td>{{ norm.notes|default:"‚Äî" }}</td>
                      <td>
                        <a href="{% url 'admin:directory_medicalexaminationnorm_change' norm.id %}" class="edit-link">‚úèÔ∏è</a>
                        <a href="{% url 'admin:directory_medicalexaminationnorm_delete' norm.id %}" class="delete-link">üóëÔ∏è</a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>
{% endblock %}