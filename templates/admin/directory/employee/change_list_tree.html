{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
<div id="content-main">
  <div class="object-tools">
    <a href="{% url 'admin:directory_employee_add' %}" class="addlink">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</a>
  </div>
  <form id="changelist-form" method="post" novalidate>
    {% csrf_token %}
    {% if action_form and actions_on_top and cl.show_admin_actions %}
      <div class="actions">
        {% for field in action_form %}
          {% if field.label %}<label>{{ field.label }}</label>{% endif %}
          {{ field }}
        {% endfor %}
        <button type="submit" class="button" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
        <span class="action-counter" style="display: none;">0 –∏–∑ {{ cl.result_count }} –≤—ã–±—Ä–∞–Ω–æ</span>
      </div>
    {% endif %}

    <div class="tree-controls">
      <button type="button" class="tree-btn expand-all">‚Üì –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
      <button type="button" class="tree-btn collapse-all">‚Üë –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
      <div class="tree-search-container">
        <input type="text" class="tree-search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –¥–µ—Ä–µ–≤—É...">
      </div>
    </div>

    <div class="results">
      <table id="result_list">
        <thead>
          <tr>
            <th class="column-checkbox"><input type="checkbox" id="select-all"></th>
            <th class="column-name">–°–û–¢–†–£–î–ù–ò–ö</th>
            <th class="column-safety">–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–´–ô –ó–ê –û–¢</th>
            <th class="column-internship">–†–£–ö–û–í–û–î–ò–¢–ï–õ–¨ –°–¢–ê–ñ–ò–†–û–í–ö–ò</th>
            <th class="column-commission">–†–û–õ–¨ –í –ö–û–ú–ò–°–°–ò–ò</th>
            <th class="column-status">–°–¢–ê–¢–£–°</th>
            <th class="column-actions">–î–ï–ô–°–¢–í–ò–Ø</th>
          </tr>
        </thead>
        <tbody>
          {% for org, org_data in tree.items %}
            <tr class="tree-row" data-level="0" data-node-id="org_{{ org.id }}">
              <td class="field-checkbox"></td>
              <td class="field-name">
                <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                <span class="tree-icon">{{ tree_settings.icons.organization|default:"üè¢" }}</span>
                <strong>{{ org_data.name }}</strong>
              </td>
              <td class="field-safety"></td>
              <td class="field-internship"></td>
              <td class="field-commission"></td>
              <td class="field-status"></td>
              <td class="field-actions"></td>
            </tr>

            {# –≠–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ subdivision #}
            {% for item in org_data.items %}
              {% include "admin/directory/employee/_employee_row.html" with item=item level=1 parent_id="org_{{ org.id }}" %}
            {% endfor %}

            {# –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è #}
            {% for sub, sub_data in org_data.subdivisions.items %}
              <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}" data-node-id="sub_{{ sub.id }}">
                <td class="field-checkbox"></td>
                <td class="field-name">
                  <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                  <span class="tree-icon">{{ tree_settings.icons.subdivision }}</span>
                  {{ sub_data.name }}
                </td>
                <td class="field-safety"></td>
                <td class="field-internship"></td>
                <td class="field-commission"></td>
                <td class="field-status"></td>
                <td class="field-actions"></td>
              </tr>

              {# –≠–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ department #}
              {% for item in sub_data.items %}
                {% include "admin/directory/employee/_employee_row.html" with item=item level=2 parent_id="sub_{{ sub.id }}" %}
              {% endfor %}

              {# –û—Ç–¥–µ–ª—ã #}
              {% for dept, dept_data in sub_data.departments.items %}
                <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}" data-node-id="dept_{{ dept.id }}">
                  <td class="field-checkbox"></td>
                  <td class="field-name">
                    <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                    <span class="tree-icon">{{ tree_settings.icons.department }}</span>
                    {{ dept_data.name }}
                  </td>
                  <td class="field-safety"></td>
                  <td class="field-internship"></td>
                  <td class="field-commission"></td>
                  <td class="field-status"></td>
                  <td class="field-actions"></td>
                </tr>

                {% for item in dept_data.items %}
                  {% include "admin/directory/employee/_employee_row.html" with item=item level=3 parent_id="dept_{{ dept.id }}" %}
                {% endfor %}
              {% endfor %}
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/tree_view.css' %}">
  <script src="{% static 'admin/js/tree_view.js' %}"></script>
  <script src="{% static 'admin/js/tree_search.js' %}"></script>
  <style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ */
    .employee-attribute {
      font-size: 16px;
      text-align: center;
      display: block;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–æ–ª–µ–π –≤ –∫–æ–º–∏—Å—Å–∏–∏ */
    .commission-role {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      padding: 2px 4px;
      border-radius: 4px;
      margin-bottom: 2px;
      white-space: nowrap;
    }

    .commission-role.chairman {
      background-color: #ffd700;
      color: #000;
    }

    .commission-role.secretary {
      background-color: #d1e7dd;
      color: #0f5132;
    }

    .commission-role.member {
      background-color: #e2e3e5;
      color: #383d41;
    }

    .commission-icon {
      font-style: normal;
      margin-right: 3px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ */
    .contract-type-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      white-space: nowrap;
    }

    .contract-type-badge.standard {
      background-color: #28a745;
      color: white;
    }

    .contract-type-badge.contractor {
      background-color: #fd7e14;
      color: white;
    }

    .contract-type-badge.part_time {
      background-color: #17a2b8;
      color: white;
    }

    .contract-type-badge.transfer {
      background-color: #6f42c1;
      color: white;
    }

    .contract-type-badge.return {
      background-color: #20c997;
      color: white;
    }

    .contract-type-badge.fired {
      background-color: #dc3545;
      color: white;
    }

    /* –°—Ç—Ä–æ–∫–∞ —É–≤–æ–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ */
    .status-fired {
      background-color: #ffeeee;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    .btn-action {
      display: inline-block;
      padding: 2px 5px;
      border-radius: 3px;
      text-decoration: none;
    }

    .btn-action:hover {
      background-color: #f0f0f0;
    }

    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ */
    .column-safety, .column-internship {
      width: 150px;
      text-align: center;
    }

    .column-commission {
      width: 180px;
      text-align: center;
    }

    .column-status {
      width: 120px;
      text-align: center;
    }

    .column-actions {
      width: 120px;
      text-align: center;
    }

    .field-safety, .field-internship, .field-commission, .field-status, .field-actions {
      text-align: center;
    }

    /* –§–∏–∫—Å –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –¥–µ—Ä–µ–≤–∞ */
    .toggle-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
      padding: 0 3px;
      font-size: 14px;
    }
  </style>

  <script type="text/javascript">
    // –ü–æ–≤—Ç–æ—Ä–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
      const toggleButtons = document.querySelectorAll('.toggle-btn');

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–æ–ø–∫–∏
      toggleButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          const row = this.closest('tr');
          const nodeId = row.getAttribute('data-node-id');
          const currentState = this.getAttribute('data-state');

          // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö parent-id —Ä–∞–≤–µ–Ω nodeId —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
          const childRows = document.querySelectorAll(`tr[data-parent-id="${nodeId}"]`);

          if (currentState === 'expanded') {
            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º - —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
            childRows.forEach(function(childRow) {
              childRow.style.display = 'none';

              // –ï—Å–ª–∏ —É –¥–æ—á–µ—Ä–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –µ—Å—Ç—å —Å–≤–æ–∏ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —Å–∫—Ä—ã–≤–∞–µ–º –∏ –∏—Ö
              const childNodeId = childRow.getAttribute('data-node-id');
              if (childNodeId) {
                const grandChildRows = document.querySelectorAll(`tr[data-parent-id="${childNodeId}"]`);
                grandChildRows.forEach(function(grandChildRow) {
                  grandChildRow.style.display = 'none';
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–æ—á–µ—Ä–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                const childToggleBtn = childRow.querySelector('.toggle-btn');
                if (childToggleBtn) {
                  childToggleBtn.textContent = '[+]';
                  childToggleBtn.setAttribute('data-state', 'collapsed');
                }
              }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–∏
            this.textContent = '[+]';
            this.setAttribute('data-state', 'collapsed');
          } else {
            // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
            childRows.forEach(function(childRow) {
              childRow.style.display = '';
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–∏
            this.textContent = '[-]';
            this.setAttribute('data-state', 'expanded');
          }
        });
      });

      // –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ–≥–æ –¥–µ—Ä–µ–≤–∞
      const expandAllBtn = document.querySelector('.expand-all');
      const collapseAllBtn = document.querySelector('.collapse-all');

      if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
          const allRows = document.querySelectorAll('.tree-row');
          const allToggleButtons = document.querySelectorAll('.toggle-btn');

          allRows.forEach(function(row) {
            row.style.display = '';
          });

          allToggleButtons.forEach(function(btn) {
            btn.textContent = '[-]';
            btn.setAttribute('data-state', 'expanded');
          });
        });
      }

      if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function() {
          const parentRows = document.querySelectorAll('.tree-row[data-level="0"]');

          parentRows.forEach(function(parentRow) {
            const nodeId = parentRow.getAttribute('data-node-id');
            const toggleBtn = parentRow.querySelector('.toggle-btn');

            // –ù–∞—Ö–æ–¥–∏–º –∏ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
            const childRows = document.querySelectorAll(`tr[data-parent-id="${nodeId}"]`);
            childRows.forEach(function(childRow) {
              childRow.style.display = 'none';

              // –ï—Å–ª–∏ —É –¥–æ—á–µ—Ä–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –µ—Å—Ç—å —Å–≤–æ–∏ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Ö –∫–Ω–æ–ø–∫–∏
              const childNodeId = childRow.getAttribute('data-node-id');
              if (childNodeId) {
                const childToggleBtn = childRow.querySelector('.toggle-btn');
                if (childToggleBtn) {
                  childToggleBtn.textContent = '[+]';
                  childToggleBtn.setAttribute('data-state', 'collapsed');
                }
              }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
            if (toggleBtn) {
              toggleBtn.textContent = '[+]';
              toggleBtn.setAttribute('data-state', 'collapsed');
            }
          });
        });
      }
    });
  </script>
{% endblock %}