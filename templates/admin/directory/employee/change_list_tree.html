{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
<div id="content-main">
  <div class="object-tools">
    <a href="{% url 'admin:directory_employee_add' %}" class="addlink">
      –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    </a>
  </div>
  <form id="changelist-form" method="post"
        {% if cl.formset and cl.formset.is_multipart %} enctype="multipart/form-data"{% endif %}
        novalidate>
    {% csrf_token %}
    {% if action_form and actions_on_top and cl.show_admin_actions %}
      <div class="actions">
        {% for field in action_form %}
          {% if field.label %}<label>{{ field.label }}</label>{% endif %}
          {{ field }}
        {% endfor %}
        <button type="submit" class="button" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
        <span class="action-counter" style="display: none;">0 –∏–∑ {{ cl.result_count }} –≤—ã–±—Ä–∞–Ω–æ</span>
      </div>
    {% endif %}

    <div class="tree-controls">
      <button type="button" class="tree-btn expand-all">‚Üì –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
      <button type="button" class="tree-btn collapse-all">‚Üë –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
      <div class="tree-search-container">
        <input type="text" class="tree-search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...">
      </div>
    </div>

    <div class="results">
      <table id="result_list">
        <thead>
          <tr>
            <th class="column-checkbox"><input type="checkbox" id="select-all"></th>
            <th class="column-name">–°–û–¢–†–£–î–ù–ò–ö</th>
            <th class="column-safety">–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–´–ô –ü–û –û–¢</th>
            <th class="column-internship">–†–£–ö–û–í–û–î–ò–¢–ï–õ–¨ –°–¢–ê–ñ–ò–†–û–í–ö–ò</th>
            <th class="column-commission">–†–û–õ–¨ –í –ö–û–ú–ò–°–°–ò–ò</th>
            <th class="column-status">–°–¢–ê–¢–£–°</th>
            <th class="column-actions">–î–ï–ô–°–¢–í–ò–Ø</th>
          </tr>
        </thead>
        <tbody>
          {% for org, org_data in tree.items %}
            <tr class="tree-row" data-level="0" data-node-id="org_{{ org.id }}">
              <td class="field-checkbox"></td>
              <td class="field-name">
                <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                <span class="tree-icon">{{ tree_settings.icons.organization|default:"üè¢" }}</span>
                <strong>{{ org_data.name }}</strong>
              </td>
              <td colspan="5"></td>
            </tr>

            {# –≠–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ subdivision #}
            {% for item in org_data.items %}
              <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}">
                <td class="field-checkbox">
                  <input type="checkbox" name="_selected_action" value="{{ item.object.pk }}" class="action-select">
                </td>
                <td class="field-name">
                  <span class="tree-icon">{{ tree_settings.icons.employee|default:"üë§" }}</span>
                  <a href="{% url 'admin:directory_employee_change' item.object.pk %}">
                    {{ item.name }}
                  </a>
                </td>

                <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ –û–¢ -->
                <td class="field-safety text-center">
                  {% if item.additional_data.is_responsible_for_safety %}
                    <span class="safety-indicator">‚úÖ</span>
                  {% else %}
                    <span class="empty-indicator">‚Äî</span>
                  {% endif %}
                </td>

                <!-- –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∏ -->
                <td class="field-internship text-center">
                  {% if item.additional_data.can_be_internship_leader %}
                    <span class="internship-indicator">‚úÖ</span>
                  {% else %}
                    <span class="empty-indicator">‚Äî</span>
                  {% endif %}
                </td>

                <!-- –†–æ–ª—å –≤ –∫–æ–º–∏—Å—Å–∏–∏ -->
                <td class="field-commission">
                  {% for role in item.additional_data.commission_roles %}
                    <span class="commission-role" title="{{ role.commission_name }}: {{ role.role_display }}">
                      {{ role.role_emoji }}
                    </span>
                  {% empty %}
                    <span class="empty-indicator">‚Äî</span>
                  {% endfor %}
                </td>

                <!-- –°—Ç–∞—Ç—É—Å -->
                <td class="field-status">
                  <span class="status-badge status-{{ item.additional_data.status }}">
                    {{ item.additional_data.status_emoji }} {{ item.additional_data.status_display }}
                  </span>
                </td>

                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <td class="field-actions">
                  <a href="{% url 'admin:directory_employee_change' item.object.pk %}" class="edit-link" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                  <a href="{% url 'admin:directory_employee_delete' item.object.pk %}" class="delete-link" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</a>
                  <a href="{% url 'admin:directory_employee_history' item.object.pk %}" class="history-link" title="–ò—Å—Ç–æ—Ä–∏—è">üìã</a>
                </td>
              </tr>
            {% endfor %}

            {# –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è #}
            {% for sub, sub_data in org_data.subdivisions.items %}
              <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}" data-node-id="sub_{{ sub.id }}">
                <td class="field-checkbox"></td>
                <td class="field-name">
                  <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                  <span class="tree-icon">{{ tree_settings.icons.subdivision|default:"üè≠" }}</span>
                  {{ sub_data.name }}
                </td>
                <td colspan="5"></td>
              </tr>

              {# –≠–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ department #}
              {% for item in sub_data.items %}
                <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}">
                  <td class="field-checkbox">
                    <input type="checkbox" name="_selected_action" value="{{ item.object.pk }}" class="action-select">
                  </td>
                  <td class="field-name">
                    <span class="tree-icon">{{ tree_settings.icons.employee|default:"üë§" }}</span>
                    <a href="{% url 'admin:directory_employee_change' item.object.pk %}">
                      {{ item.name }}
                    </a>
                  </td>

                  <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ –û–¢ -->
                  <td class="field-safety text-center">
                    {% if item.additional_data.is_responsible_for_safety %}
                      <span class="safety-indicator">‚úÖ</span>
                    {% else %}
                      <span class="empty-indicator">‚Äî</span>
                    {% endif %}
                  </td>

                  <!-- –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∏ -->
                  <td class="field-internship text-center">
                    {% if item.additional_data.can_be_internship_leader %}
                      <span class="internship-indicator">‚úÖ</span>
                    {% else %}
                      <span class="empty-indicator">‚Äî</span>
                    {% endif %}
                  </td>

                  <!-- –†–æ–ª—å –≤ –∫–æ–º–∏—Å—Å–∏–∏ -->
                  <td class="field-commission">
                    {% for role in item.additional_data.commission_roles %}
                      <span class="commission-role" title="{{ role.commission_name }}: {{ role.role_display }}">
                        {{ role.role_emoji }}
                      </span>
                    {% empty %}
                      <span class="empty-indicator">‚Äî</span>
                    {% endfor %}
                  </td>

                  <!-- –°—Ç–∞—Ç—É—Å -->
                  <td class="field-status">
                    <span class="status-badge status-{{ item.additional_data.status }}">
                      {{ item.additional_data.status_emoji }} {{ item.additional_data.status_display }}
                    </span>
                  </td>

                  <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                  <td class="field-actions">
                    <a href="{% url 'admin:directory_employee_change' item.object.pk %}" class="edit-link" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                    <a href="{% url 'admin:directory_employee_delete' item.object.pk %}" class="delete-link" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</a>
                    <a href="{% url 'admin:directory_employee_history' item.object.pk %}" class="history-link" title="–ò—Å—Ç–æ—Ä–∏—è">üìã</a>
                  </td>
                </tr>
              {% endfor %}

              {# –û—Ç–¥–µ–ª—ã #}
              {% for dept, dept_data in sub_data.departments.items %}
                <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}" data-node-id="dept_{{ dept.id }}">
                  <td class="field-checkbox"></td>
                  <td class="field-name">
                    <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                    <span class="tree-icon">{{ tree_settings.icons.department|default:"üìÇ" }}</span>
                    {{ dept_data.name }}
                  </td>
                  <td colspan="5"></td>
                </tr>

                {% for item in dept_data.items %}
                  <tr class="tree-row" data-level="3" data-parent-id="dept_{{ dept.id }}">
                    <td class="field-checkbox">
                      <input type="checkbox" name="_selected_action" value="{{ item.object.pk }}" class="action-select">
                    </td>
                    <td class="field-name">
                      <span class="tree-icon">{{ tree_settings.icons.employee|default:"üë§" }}</span>
                      <a href="{% url 'admin:directory_employee_change' item.object.pk %}">
                        {{ item.name }}
                      </a>
                    </td>

                    <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ –û–¢ -->
                    <td class="field-safety text-center">
                      {% if item.additional_data.is_responsible_for_safety %}
                        <span class="safety-indicator">‚úÖ</span>
                      {% else %}
                        <span class="empty-indicator">‚Äî</span>
                      {% endif %}
                    </td>

                    <!-- –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∏ -->
                    <td class="field-internship text-center">
                      {% if item.additional_data.can_be_internship_leader %}
                        <span class="internship-indicator">‚úÖ</span>
                      {% else %}
                        <span class="empty-indicator">‚Äî</span>
                      {% endif %}
                    </td>

                    <!-- –†–æ–ª—å –≤ –∫–æ–º–∏—Å—Å–∏–∏ -->
                    <td class="field-commission">
                      {% for role in item.additional_data.commission_roles %}
                        <span class="commission-role" title="{{ role.commission_name }}: {{ role.role_display }}">
                          {{ role.role_emoji }}
                        </span>
                      {% empty %}
                        <span class="empty-indicator">‚Äî</span>
                      {% endfor %}
                    </td>

                    <!-- –°—Ç–∞—Ç—É—Å -->
                    <td class="field-status">
                      <span class="status-badge status-{{ item.additional_data.status }}">
                        {{ item.additional_data.status_emoji }} {{ item.additional_data.status_display }}
                      </span>
                    </td>

                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                    <td class="field-actions">
                      <a href="{% url 'admin:directory_employee_change' item.object.pk %}" class="edit-link" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                      <a href="{% url 'admin:directory_employee_delete' item.object.pk %}" class="delete-link" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</a>
                      <a href="{% url 'admin:directory_employee_history' item.object.pk %}" class="history-link" title="–ò—Å—Ç–æ—Ä–∏—è">üìã</a>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/tree_view.css' %}">
  <script src="{% static 'admin/js/tree_view.js' %}"></script>
  <script src="{% static 'admin/js/tree_search.js' %}"></script>
  <style>
    /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —è—á–µ–π–∫–∞—Ö */
    .text-center {
      text-align: center;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –±—É–ª–µ–≤—ã—Ö –ø–æ–ª–µ–π */
    .safety-indicator, .internship-indicator {
      font-size: 18px;
      color: #28a745;
    }

    /* –ü—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è */
    .empty-indicator {
      color: #868e96;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–æ–ª–µ–π –≤ –∫–æ–º–∏—Å—Å–∏—è—Ö */
    .commission-role {
      display: inline-block;
      margin-right: 5px;
      font-size: 18px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ */
    .status-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: inline-block;
    }

    .status-active {
      background-color: #28a745;
      color: white;
    }

    .status-candidate {
      background-color: #6c757d;
      color: white;
    }

    .status-fired {
      background-color: #dc3545;
      color: white;
    }

    .status-maternity_leave {
      background-color: #fd7e14;
      color: white;
    }

    .status-part_time {
      background-color: #17a2b8;
      color: white;
    }

    /* –î–µ–π—Å—Ç–≤–∏—è */
    .field-actions a {
      margin-right: 8px;
      font-size: 16px;
      text-decoration: none;
    }

    .edit-link:hover {
      color: #007bff;
    }

    .delete-link:hover {
      color: #dc3545;
    }

    .history-link:hover {
      color: #17a2b8;
    }
  </style>
{% endblock %}